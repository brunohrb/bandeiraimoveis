<script>
    // ========================================================================
    // 1. CONFIGURA√á√ÉO DO SUPABASE
    //    Coloque aqui a URL e a Chave P√∫blica (anon) do seu projeto.
    // ========================================================================
const SUPABASE_URL = 'https://fmwmrjawsitbblkxaoxo.supabase.co';
const SUPABASE_KEY = 'sb_publishable_uz9C7uRoMV8nvFAx-L7Dfg_mdOQ2L4X';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ========================================================================
    // 2. VARI√ÅVEIS GLOBAIS E CONSTANTES
    //    Mantivemos suas vari√°veis, mas agora 'db' ser√° carregado do Supabase.
    // ========================================================================
    let db = { predios: [], lancamentos: [] }; // Objeto local para cache dos dados
    let currentBase64 = "";
    let currentViewingPredioId = null;
    let currentInquilino = null; // Guarda o objeto completo do inquilino atual
    let currentUnidade = null; // Guarda o objeto completo da unidade atual
    const MESES = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    const HOJE = new Date();

    // ========================================================================
    // 3. FUN√á√ïES PRINCIPAIS DE DADOS (AGORA COM SUPABASE)
    //    Essas s√£o as fun√ß√µes que leem e escrevem no banco de dados.
    // ========================================================================

    /**
     * Carrega todos os dados essenciais do Supabase para a vari√°vel local 'db'.
     * Esta fun√ß√£o √© o novo ponto de partida do sistema.
     */
    async function carregarDadosIniciais() {
        console.log("Carregando dados do Supabase...");

        // Busca pr√©dios e suas unidades relacionadas de uma s√≥ vez
        const { data: prediosData, error: prediosError } = await supabase
            .from('predios')
            .select(`
                *,
                unidades ( * )
            `)
            .order('created_at', { ascending: true });

        if (prediosError) {
            console.error('Erro ao buscar pr√©dios:', prediosError);
            alert('N√£o foi poss√≠vel carregar os dados dos pr√©dios. Verifique o console.');
            return;
        }

        // Busca todos os lan√ßamentos financeiros
        const { data: lancamentosData, error: lancamentosError } = await supabase
            .from('lancamentos')
            .select('*');

        if (lancamentosError) {
            console.error('Erro ao buscar lan√ßamentos:', lancamentosError);
            alert('N√£o foi poss√≠vel carregar os dados financeiros. Verifique o console.');
            return;
        }

        db.predios = prediosData;
        db.lancamentos = lancamentosData;

        console.log("Dados carregados:", db);
        render(); // Renderiza a tela inicial com os dados carregados
    }

    /**
     * Adiciona um novo pr√©dio e suas unidades ao Supabase.
     */
    async function addPredio() {
        const nome = document.getElementById('pNome').value;
        const unidadesTxt = document.getElementById('pUnidades').value;
        if (!nome || !unidadesTxt) return alert("Preencha o nome e as unidades do pr√©dio.");

        // 1. Insere o pr√©dio
        const { data: predioData, error: predioError } = await supabase
            .from('predios')
            .insert({ nome: nome })
            .select()
            .single();

        if (predioError) {
            console.error('Erro ao criar pr√©dio:', predioError);
            return alert('Falha ao criar o pr√©dio.');
        }

        // 2. Prepara as unidades para inser√ß√£o
        const unidadesParaInserir = unidadesTxt.split(',').map(u => ({
            nome: u.trim(),
            predio_id: predioData.id,
            status: 'vago',
            inquilino: null
        }));

        // 3. Insere as unidades
        const { error: unidadesError } = await supabase
            .from('unidades')
            .insert(unidadesParaInserir);

        if (unidadesError) {
            console.error('Erro ao criar unidades:', unidadesError);
            return alert('Pr√©dio criado, mas falha ao adicionar unidades.');
        }

        document.getElementById('pNome').value = '';
        document.getElementById('pUnidades').value = '';
        closeModal('modalPredio');
        carregarDadosIniciais(); // Recarrega tudo para mostrar o novo pr√©dio
    }

    /**
     * Salva os dados de um inquilino em uma unidade espec√≠fica.
     */
    async function saveInquilino() {
        const unidadeId = document.getElementById('inqUnidadeId').value;
        const predioId = document.getElementById('inqPredioId').value;

        // Garante que temos uma unidade selecionada
        if (!currentUnidade) {
            alert("Erro: Nenhuma unidade selecionada para salvar o inquilino.");
            return;
        }

        // Cria o objeto do inquilino com os dados do formul√°rio
        const inquilinoData = {
            id: currentUnidade.inquilino?.id || Math.random().toString(36).substr(2, 9),
            nome: document.getElementById('inqNome').value,
            telefone: document.getElementById('inqTelefone').value,
            valor: document.getElementById('inqValor').value,
            venc: document.getElementById('inqVenc').value,
            caucao: parseFloat(document.getElementById('inqCaucao').value) || 0,
            contrato: currentBase64 || currentUnidade.inquilino?.contrato || "",
            pagamentos: currentUnidade.inquilino?.pagamentos || Array.from({ length: 12 }, () => ({ pago: false })),
            // Adiciona os novos campos do formul√°rio
            nacionalidade: document.getElementById('inqNacionalidade').value,
            profissao: document.getElementById('inqProfissao').value,
            rg: document.getElementById('inqRG').value,
            cpf: document.getElementById('inqCPF').value,
            endereco: document.getElementById('inqEndereco').value,
        };

        // Atualiza a unidade no Supabase com os novos dados do inquilino
        const { error } = await supabase
            .from('unidades')
            .update({ inquilino: inquilinoData, status: 'ocupado' })
            .eq('id', unidadeId);

        if (error) {
            console.error("Erro ao salvar inquilino:", error);
            return alert("Falha ao salvar os dados do inquilino.");
        }

        // L√≥gica para registrar a cau√ß√£o como um lan√ßamento financeiro
        const caucaoValor = inquilinoData.caucao;
        if (caucaoValor > 0) {
            // Verifica se j√° existe um lan√ßamento de cau√ß√£o para este inquilino nesta unidade
            const jaExisteCaucao = db.lancamentos.some(l =>
                l.categoria === 'caucao' &&
                l.observacao.includes(inquilinoData.nome) &&
                l.observacao.includes(currentUnidade.nome)
            );

            if (!jaExisteCaucao) {
                await supabase.from('lancamentos').insert({
                    tipo: 'receita',
                    categoria: 'caucao',
                    valor: caucaoValor,
                    data: new Date().toISOString().split('T')[0],
                    predio_id: predioId,
                    observacao: `Cau√ß√£o de ${inquilinoData.nome} - Unidade ${currentUnidade.nome}`
                });
            }
        }

        closeModal('modalInquilino');
        carregarDadosIniciais(); // Recarrega tudo para refletir a mudan√ßa
    }

    /**
     * Remove o inquilino de uma unidade (desocupa).
     */
    async function vacarUnidade() {
        if (!confirm("Remover inquilino desta unidade?")) return;
        const unidadeId = document.getElementById('inqUnidadeId').value;

        const { error } = await supabase
            .from('unidades')
            .update({ inquilino: null, status: 'vago' })
            .eq('id', unidadeId);

        if (error) {
            console.error("Erro ao desocupar unidade:", error);
            return alert("Falha ao remover inquilino.");
        }

        closeModal('modalInquilino');
        carregarDadosIniciais();
    }

    /**
     * Confirma o pagamento de um aluguel, atualizando o inquilino e criando lan√ßamentos financeiros.
     */
    async function confirmarPagamento() {
        const mes = window.mesBaixaAtual;
        const aluguel = parseFloat(document.getElementById('bpAluguel').value) || 0;
        const juros = parseFloat(document.getElementById('bpJuros').value) || 0;
        const data = document.getElementById('bpData').value || new Date().toISOString().split('T')[0];

        // Atualiza o objeto de pagamentos do inquilino
        currentInquilino.pagamentos[mes] = {
            pago: true,
            aluguel: aluguel,
            juros: juros,
            data: data
        };

        // Salva o objeto inquilino inteiro de volta na unidade
        const { error: updateError } = await supabase
            .from('unidades')
            .update({ inquilino: currentInquilino })
            .eq('id', currentUnidade.id);

        if (updateError) {
            console.error("Erro ao atualizar pagamento:", updateError);
            alert("Falha ao salvar o pagamento.");
            // Reverte a altera√ß√£o local em caso de erro
            currentInquilino.pagamentos[mes] = { pago: false };
            return;
        }

        // Cria os lan√ßamentos financeiros
        const lancamentosParaInserir = [];
        lancamentosParaInserir.push({
            tipo: 'receita',
            categoria: 'aluguel',
            valor: aluguel,
            data: data,
            predio_id: currentUnidade.predio_id,
            observacao: `Aluguel de ${currentInquilino.nome} - M√™s: ${MESES[mes]}`
        });

        if (juros > 0) {
            lancamentosParaInserir.push({
                tipo: 'receita',
                categoria: 'juros',
                valor: juros,
                data: data,
                predio_id: currentUnidade.predio_id,
                observacao: `Juros/Multa de ${currentInquilino.nome} - M√™s: ${MESES[mes]}`
            });
        }

        const { error: lancamentoError } = await supabase.from('lancamentos').insert(lancamentosParaInserir);
        if (lancamentoError) {
            console.error("Erro ao criar lan√ßamentos financeiros:", lancamentoError);
            // O ideal aqui seria ter uma transa√ß√£o, mas por simplicidade apenas avisamos.
            alert("Pagamento salvo, mas houve um erro ao registrar no financeiro.");
        }

        closeModal('modalBaixaPagamento');
        renderPagamentosGrid(currentInquilino); // Atualiza a grade de pagamentos na tela
        carregarDadosIniciais(); // Recarrega todos os dados para consist√™ncia
    }

    /**
     * Reverte um pagamento, atualizando o inquilino e removendo os lan√ßamentos financeiros.
     */
    async function reverterPagamento(mesIndex) {
        const mesNome = MESES[mesIndex];
        if (!confirm(`Deseja reverter o pagamento de ${mesNome}? Esta a√ß√£o n√£o pode ser desfeita.`)) return;

        const pagamentoOriginal = currentInquilino.pagamentos[mesIndex];
        currentInquilino.pagamentos[mesIndex] = { pago: false };

        // 1. Atualiza o inquilino no banco
        const { error: updateError } = await supabase
            .from('unidades')
            .update({ inquilino: currentInquilino })
            .eq('id', currentUnidade.id);

        if (updateError) {
            console.error("Erro ao reverter pagamento (update):", updateError);
            alert("Falha ao reverter o pagamento.");
            currentInquilino.pagamentos[mesIndex] = pagamentoOriginal; // Restaura localmente
            return;
        }

        // 2. Remove os lan√ßamentos financeiros associados
        const obsAluguel = `Aluguel de ${currentInquilino.nome} - M√™s: ${mesNome}`;
        const obsJuros = `Juros/Multa de ${currentInquilino.nome} - M√™s: ${mesNome}`;

        await supabase.from('lancamentos').delete().eq('observacao', obsAluguel);
        if (pagamentoOriginal.juros > 0) {
            await supabase.from('lancamentos').delete().eq('observacao', obsJuros);
        }

        renderPagamentosGrid(currentInquilino);
        carregarDadosIniciais();
    }

    /**
     * Salva uma nova despesa ou edita uma existente.
     */
    async function salvarDespesa() {
        const descricao = document.getElementById('despDescricao').value;
        const categoria = document.getElementById('despCategoria').value;
        const valor = parseFloat(document.getElementById('despValor').value);
        const data = document.getElementById('despData').value;
        const predioId = document.getElementById('despPredio').value || null;

        if (!descricao || !valor || !data) {
            return alert("Preencha descri√ß√£o, valor e data.");
        }

        const lancamento = {
            tipo: 'despesa',
            categoria: categoria,
            valor: valor,
            data: data,
            predio_id: predioId,
            observacao: descricao
        };

        let error;
        if (window.despesaEditandoId) {
            // Editando
            const { error: updateError } = await supabase
                .from('lancamentos')
                .update(lancamento)
                .eq('id', window.despesaEditandoId);
            error = updateError;
        } else {
            // Criando
            const { error: insertError } = await supabase
                .from('lancamentos')
                .insert(lancamento);
            error = insertError;
        }

        if (error) {
            console.error("Erro ao salvar despesa:", error);
            return alert("Falha ao salvar a despesa.");
        }

        window.despesaEditandoId = null;
        closeModal('modalDespesa');
        carregarDadosIniciais();
    }

    /**
     * Exclui uma despesa do banco de dados.
     */
    async function excluirDespesa(id) {
        if (!confirm("Deseja realmente excluir esta despesa?")) return;

        const { error } = await supabase
            .from('lancamentos')
            .delete()
            .eq('id', id);

        if (error) {
            console.error("Erro ao excluir despesa:", error);
            return alert("Falha ao excluir a despesa.");
        }
        carregarDadosIniciais();
    }

    /**
     * Remove um pr√©dio e todas as suas unidades (gra√ßas ao 'ON DELETE CASCADE').
     */
    async function removerPredio(predioId) {
        const p = db.predios.find(x => x.id === predioId);
        if (!p) return;

        if (!confirm(`Tem certeza que deseja excluir o pr√©dio "${p.nome}"?\n\n‚ö†Ô∏è Isso ir√° remover TODAS as unidades e inquilinos deste pr√©dio de forma permanente.`)) return;

        const { error } = await supabase.from('predios').delete().eq('id', predioId);

        if (error) {
            console.error("Erro ao remover pr√©dio:", error);
            return alert("Falha ao remover o pr√©dio. Verifique se h√° lan√ßamentos financeiros ligados a ele e tente novamente.");
        }
        carregarDadosIniciais();
    }

    // ========================================================================
    // 4. FUN√á√ïES DE RENDERIZA√á√ÉO E UI (INTERFACE DO USU√ÅRIO)
    //    Essas fun√ß√µes n√£o mudaram muito, elas apenas leem da vari√°vel 'db' local.
    // ========================================================================

    function render() {
        if (!db || !db.predios) return;
        const grid = document.getElementById('gridPredios');
        grid.innerHTML = db.predios.map(p => {
            const livres = p.unidades.filter(u => u.status === 'vago').length;
            const ocupados = p.unidades.length - livres;
            let inadimplentesCount = 0;
            p.unidades.forEach(u => {
                if (u.inquilino) {
                    const mesAtual = HOJE.getMonth();
                    const diaVenc = parseInt(u.inquilino.venc);
                    const pagamentoMes = u.inquilino.pagamentos[mesAtual];
                    if ((!pagamentoMes || !pagamentoMes.pago) && HOJE.getDate() > diaVenc) {
                        inadimplentesCount++;
                    }
                }
            });

            return `
            <div class="card relative cursor-pointer hover:shadow-xl transition" onclick="viewPredio(${p.id})">
                <div class="absolute top-2 right-2 flex gap-1">
                    <button onclick="event.stopPropagation(); removerPredio(${p.id})" class="text-slate-400 hover:text-red-600 text-xs p-1" title="Apagar pr√©dio">üóëÔ∏è</button>
                </div>
                <div class="flex justify-between items-start mb-6">
                    <h3 class="text-lg font-black text-slate-800 uppercase tracking-tight">${p.nome}</h3>
                    <span class="text-[10px] bg-slate-100 text-slate-500 font-bold px-2 py-1 rounded">${p.unidades.length} UNID.</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-[10px] font-bold text-blue-400 uppercase">Livres</p>
                        <p class="text-2xl font-black text-blue-900">${livres}</p>
                    </div>
                    <div class="bg-amber-50 p-3 rounded-lg border border-amber-100">
                        <p class="text-[10px] font-bold text-amber-400 uppercase">Inadimplentes</p>
                        <p class="text-2xl font-black text-amber-900">${inadimplentesCount}</p>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-between text-xs font-bold text-slate-400 uppercase">
                    <span>Ocupa√ß√£o: ${p.unidades.length > 0 ? ((ocupados / p.unidades.length) * 100).toFixed(0) : 0}%</span>
                    <i class="fas fa-arrow-right text-blue-600"></i>
                </div>
            </div>`;
        }).join('');

        // Atualiza a view financeira tamb√©m, se estiver aberta
        if (document.getElementById('viewFinanceiro').style.display !== 'none') {
            aplicarFiltros();
        }
    }

    function viewPredio(predioId) {
        currentViewingPredioId = predioId;
        const p = db.predios.find(x => x.id === predioId);
        if (!p) return;

        document.getElementById('detalheTitulo').innerText = p.nome;
        const lista = document.getElementById('listaUnidades');
        lista.innerHTML = p.unidades.sort((a, b) => a.nome.localeCompare(b.nome)).map(u => {
            const statusTag = u.status === 'vago' ? '<span class="tag tag-free">Vago</span>' : '<span class="tag tag-occupied">Ocupado</span>';
            let financeiroTag = '<span class="text-slate-300">‚Äî</span>';

            if (u.status === 'ocupado' && u.inquilino) {
                const mesAtual = HOJE.getMonth();
                const diaVenc = parseInt(u.inquilino.venc);
                const pagamentoMes = u.inquilino.pagamentos[mesAtual];

                if (pagamentoMes && pagamentoMes.pago) {
                    financeiroTag = '<span class="tag tag-free">Pago</span>';
                } else if (HOJE.getDate() > diaVenc) {
                    financeiroTag = '<span class="tag tag-late">Inadimplente</span>';
                }
            }

            const contratoBtn = u.inquilino && u.inquilino.contrato ? `<a href="${u.inquilino.contrato}" target="_blank" class="text-blue-600 hover:underline font-semibold"><i class="fas fa-file-pdf"></i> Ver Contrato</a>` : '-';
            const inquilinoNome = u.inquilino ? `<span class="cursor-pointer text-blue-700 hover:underline font-medium" onclick="viewPagamentos(${p.id}, ${u.id})">${u.inquilino.nome}</span>` : '<span class="text-slate-300 italic">Dispon√≠vel</span>';

            return `
                <tr class="border-b hover:bg-slate-50 transition text-sm">
                    <td class="py-4 font-bold text-slate-800">${u.nome}</td>
                    <td>${inquilinoNome}</td>
                    <td>${u.inquilino ? 'R$ ' + parseFloat(u.inquilino.valor).toLocaleString('pt-BR') : '-'}</td>
                    <td>${u.inquilino ? 'Dia ' + u.inquilino.venc : '-'}</td>
                    <td class="text-center">${statusTag}</td>
                    <td class="text-center">${financeiroTag}</td>
                    <td>${contratoBtn}</td>
                    <td class="text-right">
                        <button onclick="editInquilino(${p.id}, ${u.id})" class="text-blue-600 font-black text-xs uppercase hover:underline">
                            <i class="fas fa-edit"></i> ${u.inquilino ? 'Editar' : 'Alugar'}
                        </button>
                    </td>
                </tr>`;
        }).join('');
        openModal('modalDetalhe');
    }

    function editInquilino(predioId, unidadeId) {
        const p = db.predios.find(x => x.id === predioId);
        const u = p.unidades.find(x => x.id === unidadeId);
        currentUnidade = u; // Armazena a unidade atual

        document.getElementById('viewContrato').classList.add('hidden');
        document.getElementById('viewContrato').querySelector('a').href = '#';
        document.getElementById('inqArquivo').value = '';

        document.getElementById('inqPredioId').value = predioId;
        document.getElementById('inqUnidadeId').value = unidadeId;
        document.getElementById('inqTitulo').innerText = u.nome;

        if (u.inquilino) {
            const i = u.inquilino;
            document.getElementById('inqNome').value = i.nome || '';
            document.getElementById('inqValor').value = i.valor || '';
            document.getElementById('inqVenc').value = i.venc || '';
            document.getElementById('inqCaucao').value = i.caucao || 0;
            document.getElementById('inqNacionalidade').value = i.nacionalidade || '';
            document.getElementById('inqProfissao').value = i.profissao || '';
            document.getElementById('inqRG').value = i.rg || '';
            document.getElementById('inqCPF').value = i.cpf || '';
            document.getElementById('inqTelefone').value = i.telefone || '';
            document.getElementById('inqEndereco').value = i.endereco || '';
            document.getElementById('btnVacar').style.display = 'block';
            if (i.contrato) {
                document.getElementById('viewContrato').classList.remove('hidden');
                document.getElementById('viewContrato').querySelector('a').href = i.contrato;
            }
        } else {
            // Limpa todos os campos se n√£o houver inquilino
            ['inqNome', 'inqValor', 'inqVenc', 'inqCaucao', 'inqNacionalidade', 'inqProfissao', 'inqRG', 'inqCPF', 'inqTelefone', 'inqEndereco'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('btnVacar').style.display = 'none';
        }
        openModal('modalInquilino');
    }

    function viewPagamentos(predioId, unidadeId) {
        const p = db.predios.find(x => x.id === predioId);
        const u = p.unidades.find(x => x.id === unidadeId);
        if (!u || !u.inquilino) return;

        currentUnidade = u;
        currentInquilino = u.inquilino;

        document.getElementById('pagamentosTitulo').innerText = `Hist√≥rico de ${currentInquilino.nome.split(' ')[0]}`;
        renderPagamentosGrid(currentInquilino);
        openModal('modalPagamentos');
    }

    function renderPagamentosGrid(inq) {
        const grid = document.getElementById('gridPagamentos');
        grid.innerHTML = (inq.pagamentos || []).map((pag, index) => {
            const mesNome = MESES[index];
            const pago = pag && pag.pago;
            return `
            <div class="payment-month p-3 text-center rounded-lg shadow-sm ${pago ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}" onclick="handlePagamentoClick(${index})">
                <p class="font-bold">${mesNome}</p>
                <p class="text-xs">${pago ? 'Pago' : 'Pendente'}</p>
            </div>`;
        }).join('');
    }

    function handlePagamentoClick(mesIndex) {
        const pago = currentInquilino.pagamentos[mesIndex] && currentInquilino.pagamentos[mesIndex].pago;
        if (pago) {
            reverterPagamento(mesIndex);
        } else {
            abrirBaixaPagamento(mesIndex);
        }
    }

    function abrirBaixaPagamento(mesIndex) {
        window.mesBaixaAtual = mesIndex;
        document.getElementById('bpAluguel').value = currentInquilino.valor || 0;
        document.getElementById('bpJuros').value = 0;
        document.getElementById('bpData').value = new Date().toISOString().split('T')[0];
        document.getElementById('baixaSubtitulo').innerText = `${MESES[mesIndex]} ‚Ä¢ ${currentInquilino.nome}`;
        atualizarTotalBaixa();
        openModal('modalBaixaPagamento');
    }

    function renderDespesas() {
        const { mes, ano, predio } = getFiltrosFinanceiro();
        const tbody = document.getElementById('listaDespesas');
        if (!tbody) return;

        const despesasFiltradas = db.lancamentos.filter(l => {
            if (l.tipo !== 'despesa') return false;
            const dataLancamento = new Date(l.data);
            if (mes !== 'all' && dataLancamento.getMonth() != mes) return false;
            if (ano && dataLancamento.getFullYear() != ano) return false;
            if (predio !== 'all' && l.predio_id != predio) return false;
            return true;
        });

        tbody.innerHTML = despesasFiltradas.map(d => {
            const predioNome = d.predio_id ? (db.predios.find(p => p.id == d.predio_id)?.nome || '‚Äî') : 'Geral';
            return `
            <tr class="border-b hover:bg-slate-50">
                <td class="p-3">${d.observacao || '-'}</td>
                <td class="p-3 font-medium">${predioNome}</td>
                <td class="p-3 capitalize">${d.categoria}</td>
                <td class="p-3">${new Date(d.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</td>
                <td class="p-3 text-right font-bold text-red-600">R$ ${parseFloat(d.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="p-3 text-center whitespace-nowrap">
                    <button onclick="editarDespesa(${d.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">‚úèÔ∏è</button>
                    <button onclick="excluirDespesa(${d.id})" class="text-red-600 hover:text-red-800" title="Excluir">üóëÔ∏è</button>
                </td>
            </tr>`;
        }).join('');
    }

    function editarDespesa(id) {
        const d = db.lancamentos.find(l => l.id === id);
        if (!d) return;

        document.getElementById('despDescricao').value = d.observacao || '';
        document.getElementById('despCategoria').value = d.categoria;
        document.getElementById('despValor').value = d.valor;
        document.getElementById('despData').value = d.data;
        document.getElementById('despPredio').value = d.predio_id || '';

        window.despesaEditandoId = id;
        abrirModalDespesa();
    }

    // ========================================================================
    // 5. FUN√á√ïES AUXILIARES E DE UI (SEM ALTERA√á√ïES SIGNIFICATIVAS)
    //    Mantive todas as suas outras fun√ß√µes exatamente como estavam.
    // ========================================================================

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        currentBase64 = "";
        // N√£o chama mais o render() aqui para evitar recargas desnecess√°rias
    }
    function closeModalPagamentos() {
        closeModal('modalPagamentos');
        // A view do pr√©dio ser√° atualizada quando os dados forem recarregados
    }
    document.getElementById('inqArquivo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => currentBase64 = reader.result;
        reader.readAsDataURL(file);
    });
    function montarContratoTexto() { /* ... seu c√≥digo original sem altera√ß√µes ... */ return `CONTRATO...`; }
    function gerarContratoPDF() { /* ... seu c√≥digo original sem altera√ß√µes ... */ }
    function atualizarTotalBaixa() { /* ... seu c√≥digo original sem altera√ß√µes ... */ }
    function getFiltrosFinanceiro() { return { mes: document.getElementById('filtroMes').value, ano: document.getElementById('filtroAno').value, predio: document.getElementById('filtroPredio').value }; }
    function calcularFinanceiro() {
        const { mes, ano, predio } = getFiltrosFinanceiro();
        let alugueisRecebidos = 0, jurosRecebidos = 0, caucaoSaldo = 0, contasPagar = 0, inadimplencia = 0, lucro = 0;

        // Calcula saldo total de cau√ß√µes (independente do filtro)
        db.predios.forEach(p => p.unidades.forEach(u => {
            if (u.inquilino && u.inquilino.caucao) caucaoSaldo += parseFloat(u.inquilino.caucao);
        }));

        // Calcula inadimpl√™ncia do m√™s atual (independente do filtro)
        db.predios.forEach(p => p.unidades.forEach(u => {
            if (u.
