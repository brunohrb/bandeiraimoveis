<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Bandeira's Imobiliaria Gest√£o Financeira ‚Ä¢ 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="cdnjs.cloudflare.com">

 <script>
  const SUPABASE_URL = 'https://fmwmrjawsitbblkxaoxo.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_uz9C7uRoMV8nvFAx-L7Dfg_mdOQ2L4X';

  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  console.log("Supabase conectado:", supabaseClient);
</script>
    
  <style>
.card-full {
  max-width: 100% !important;
}
        :root{ --bg:#f8fafc; --primary:#1e3a8a; --border:#e2e8f0; }
        body{ font-family: 'Inter', sans-serif; background:var(--bg); color:#1e293b; }
        .sidebar{ background:#0f172a; min-height:100vh; width:260px; position:fixed; color:white; padding:20px; }
        .main{ margin-left: 260px; padding:40px; }
.card{
  background:white;
  border-radius:16px;
  padding:16px 16px 14px;
  border:1px solid var(--border);

  box-shadow:0 8px 28px rgba(0,0,0,0.06);

  width:100%;
  max-width:420px;

  max-height:calc(100vh - 40px);
  overflow-y:auto;
}
        .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); z-index:100; align-items:center; justify-content:center; }
       .btn{
  padding:8px 14px;              /* ‚¨ÖÔ∏è bot√£o mais baixo */
  border-radius:10px;
  font-weight:600;               /* ‚¨ÖÔ∏è menos ‚Äúgritado‚Äù */
  font-size:14px;

  cursor:pointer;
  transition:all .2s ease;
  border:none;

  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}

.btn-primary{
  background:var(--primary);
  color:white;
}

.btn-ghost{
  background:#f8fafc;
  color:#475569;
}

        .tag{ padding:4px 8px; border-radius:6px; font-size:11px; font-weight:800; text-transform:uppercase; display: inline-block;}
        .tag-free{ background:#dcfce7; color:#166534; }
        .tag-late{ background:#fee2e2; color:#991b1b; }
        .tag-occupied{ background:#e0f2fe; color:#0369a1; }
        .input{ width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; margin-top:4px; outline:none; }
        .payment-month { cursor: pointer; transition: transform 0.2s; }
        .payment-month:hover { transform: scale(1.05); }
label{
  font-size:12px;
  font-weight:600;
  color:#475569;
  letter-spacing:.02em;
}
.input{
  padding:10px 12px;
  font-size:14px;
  border-radius:10px;
}
@media (max-width: 640px){

  .card{
    max-width:94%;
    padding:14px;
    border-radius:18px;
  }

  .btn{
    width:100%;
  }

  .grid{
    grid-template-columns:1fr !important;
  }
}
@media (max-width:640px){
  .btn{
    width:100%;
  }
}

    </style>
</head>
<body>

<div class="sidebar">
    <!-- NOVO DESIGN DA MARCA -->
    <div class="mb-10 p-2 bg-blue-900 rounded-lg shadow-xl">
        <h2 class="text-xl font-extrabold italic text-center">Bandeira's</h2>
        <p class="text-xs text-center font-medium text-blue-300">Gest√£o Financeira</p>
    </div>
    <nav class="space-y-2">
<div
  onclick="voltarParaPortfolio()"
  class="p-3 bg-slate-800 rounded-lg cursor-pointer flex items-center gap-3 hover:bg-slate-700">
  <i class="fas fa-home"></i> Portf√≥lio 2026
</div>
<div onclick="abrirFinanceiro()"
     class="p-3 bg-slate-800 rounded-lg cursor-pointer flex items-center gap-3 hover:bg-slate-700">
  üìä Financeiro
</div>

        <div onclick="resetarSistema();" class="p-3 text-slate-400 hover:text-white cursor-pointer flex items-center gap-3 mt-10"><i class="fas fa-trash"></i> Resetar Sistema</div>
    </nav>
</div>

<div class="main">
<!-- VIEW FINANCEIRO -->
<div id="viewFinanceiro" class="hidden">

  <h1 class="text-3xl font-black mb-6">
    DASHBOARD FINANCEIRO ‚Ä¢ 2026
  </h1>

<!-- FILTROS -->
<div class="flex gap-4 mb-8 flex-wrap">

  <select id="filtroMes" class="input w-40">
    <option value="all">Todos os meses</option>
    <option value="0">Janeiro</option>
    <option value="1">Fevereiro</option>
    <option value="2">Mar√ßo</option>
    <option value="3">Abril</option>
    <option value="4">Maio</option>
    <option value="5">Junho</option>
    <option value="6">Julho</option>
    <option value="7">Agosto</option>
    <option value="8">Setembro</option>
    <option value="9">Outubro</option>
    <option value="10">Novembro</option>
    <option value="11">Dezembro</option>
  </select>

  <select id="filtroAno" class="input w-32">
    <option value="2026">2026</option>
  </select>

  <select id="filtroPredio" class="input w-64">
    <option value="all">Todos os pr√©dios</option>
  </select>

  <button class="btn btn-primary" onclick="aplicarFiltros()">
    Aplicar filtros
  </button>

<button class="btn btn-primary" onclick="abrirModalDespesa()">
  ‚ûï Nova despesa
</button>


</div>


<!-- LINHA 1: LISTA + CARD GRANDE -->
<!-- LINHA 2: CARDS RESUMO -->
<!-- CARDS DO DASHBOARD -->
<div class="grid grid-cols-3 gap-4 mb-10">

  <div class="card">
    <p class="text-xs uppercase text-slate-400">Contas a Receber</p>
    <p id="finReceber" class="text-2xl font-black text-blue-700">R$ 0,00</p>
  </div>

  <div class="card">
    <p class="text-xs uppercase text-slate-400">Alugu√©is Recebidos</p>
    <p id="finAluguelRecebido" class="text-2xl font-black text-green-700">R$ 0,00</p>
  </div>

  <div class="card">
    <p class="text-xs uppercase text-slate-400">Juros / Multas</p>
    <p id="finJuros" class="text-2xl font-black text-amber-600">R$ 0,00</p>
  </div>

  <div class="card">
    <p class="text-xs uppercase text-slate-400">Inadimpl√™ncia</p>
    <p id="finInadimplencia" class="text-2xl font-black text-red-600">R$ 0,00</p>
  </div>

  <div class="card">
    <p class="text-xs uppercase text-slate-400">Cau√ß√µes (saldo)</p>
    <p id="finCaucao" class="text-2xl font-black text-purple-700">R$ 0,00</p>
  </div>

  <div class="card">
    <p class="text-xs uppercase text-slate-400">Contas a Pagar</p>
    <p id="finPagar" class="text-2xl font-black text-slate-700">R$ 0,00</p>
  </div>

<div class="card">
  <p class="text-xs uppercase text-slate-400">Lucro</p>
  <p id="finLucro" class="text-2xl font-black text-emerald-700">
    R$ 0,00
  </p>
</div>


  <!-- CONSOLIDADO EMBAIXO, LARGO -->

</div>

<!-- LISTA CONTAS A PAGAR (EMBAIXO DE TUDO) -->
<div class="card card-full mt-10">

  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-black">Contas a pagar</h2>
    <span class="text-xs text-slate-400 uppercase">Detalhamento</span>
  </div>

  <div class="max-h-80 overflow-y-auto border rounded-lg">
    <table class="w-full text-sm">
     <thead class="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0">
  <tr>
    <th class="p-3 text-left">Descri√ß√£o</th>
    <th class="p-3 text-left">Pr√©dio</th>
    <th class="p-3 text-left">Categoria</th>
    <th class="p-3 text-left">Data</th>
    <th class="p-3 text-right">Valor</th>
<th class="p-3 text-center">A√ß√µes</th>

  </tr>
</thead>

      <tbody id="listaDespesas"></tbody>
    </table>
  </div>

</div>

</div>


<div id="viewPortfolio">
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">GEST√ÉO FINANCEIRA</h1>
            <p class="text-slate-500">Controle de pr√©dios e inquilinos. Data Atual: 06/01/2026</p>
        </div>
        <button class="btn btn-primary" onclick="openModal('modalPredio')"><i class="fas fa-plus"></i> NOVO PR√âDIO</button>
    </header>
<div id="gridPredios" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
</div>

<!-- MODAL NOVO PREDIO -->
<div id="modalPredio" class="modal">
    <div class="card w-[450px]">
        <h3 class="font-black text-xl mb-6">CADASTRAR PR√âDIO</h3>
        <label class="text-xs font-bold text-slate-400 uppercase">Nome do Condom√≠nio</label>
        <input id="pNome" class="input mb-4" placeholder="Ex: Edif√≠cio Mar Azul">
        <label class="text-xs font-bold text-slate-400 uppercase">Unidades (Separe por v√≠rgula)</label>
        <textarea id="pUnidades" class="input h-24 mb-6" placeholder="Apto 101, Apto 102, Cobertura..."></textarea>
        <div class="flex gap-2">
            <button class="btn btn-primary flex-1 justify-center" onclick="addPredio()">CRIAR PR√âDIO</button>
            <button class="btn btn-ghost" onclick="closeModal('modalPredio')"><i class="fas fa-arrow-left"></i> VOLTAR</button>
        </div>
    </div>
</div>

<!-- MODAL LISTA INQUILINOS (DETALHE DO PR√âDIO) -->
<div id="modalDetalhe" class="modal">
    <div class="card w-[90%] max-w-5xl max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 id="detalheTitulo" class="font-black text-2xl uppercase italic"></h3>
            <button class="btn btn-ghost" onclick="closeModal('modalDetalhe')"><i class="fas fa-times"></i> FECHAR</button>
        </div>
        <table class="w-full text-left">
            <thead class="text-xs text-slate-400 uppercase border-b">
                <tr>
                    <th class="pb-3">Unidade</th>
                    <th class="pb-3">Inquilino</th>
                    <th class="pb-3">Valor</th>
                    <th class="pb-3">Venc.</th>
                    <th class="pb-3">Status</th>
<th class="pb-3">Financeiro</th>
                    <th class="pb-3">Contrato</th>
                    <th class="pb-3 text-right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="listaUnidades"></tbody>
        </table>
    </div>
</div>

<!-- MODAL EDITAR/CADASTRAR INQUILINO E PAGAMENTOS -->
<div id="modalInquilino" class="modal">
    <div class="card w-[450px]">
        <h3 id="inqTitulo" class="font-black text-xl mb-6 uppercase">GERIR INQUILINO</h3>
        <input type="hidden" id="inqUnidadeId">
        <input type="hidden" id="inqPredioId">
        <div class="space-y-4">
            <div>
                <label class="text-xs font-bold">Nome Completo</label>
<input id="inqNome" class="input mb-3">

<div class="grid grid-cols-2 gap-3 mb-3">
  <div>
    <label class="text-xs font-bold">Nacionalidade</label>
    <input id="inqNacionalidade" class="input">
  </div>
  <div>
    <label class="text-xs font-bold">Profiss√£o</label>
    <input id="inqProfissao" class="input">
  </div>
</div>

<label class="text-xs font-bold">Identidade (RG)</label>
<input id="inqRG" class="input mb-3">

<label class="text-xs font-bold">CPF</label>
<input id="inqCPF" class="input mb-3">

<label class="text-xs font-bold">Telefone / WhatsApp</label>
<input id="inqTelefone" class="input mb-3" placeholder="(85) 9xxxx-xxxx">

<label class="text-xs font-bold">Endere√ßo Completo</label>
<textarea id="inqEndereco" class="input mb-3"></textarea>

<label class="text-xs font-bold">Cau√ß√£o (R$)</label>
<input id="inqCaucao" class="input mb-3">

<div class="grid grid-cols-2 gap-3 mb-3">
  <div>
    <label class="text-xs font-bold">Aluguel (R$)</label>
    <input id="inqValor" class="input" placeholder="Ex: 1.350,00">
  </div>
  <div>
    <label class="text-xs font-bold">Dia de vencimento</label>
    <input id="inqVenc" type="number" min="1" max="31" class="input">
  </div>
</div>

                <label class="text-xs font-bold text-slate-400 uppercase">Anexo do Contrato (.pdf/imagem)</label>
                <input id="inqArquivo" type="file" class="text-xs mt-2 block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <div id="viewContrato" class="mt-2 hidden"><a href="#" target="_blank" class="text-blue-600 font-bold text-xs underline uppercase tracking-widest"><i class="fas fa-file-pdf"></i> Visualizar Atual</a></div>
            </div>
            <div class="flex gap-2 pt-4">
<button class="btn btn-ghost w-full mb-2" onclick="gerarContratoPDF()">
    üìÑ Gerar contrato (PDF)
</button>
                <button class="btn btn-primary flex-1 justify-center" onclick="saveInquilino()">SALVAR DADOS</button>
                <button id="btnVacar" class="btn btn-ghost text-red-600" onclick="vacarUnidade()">REMOVER</button>
                <button class="btn btn-ghost" onclick="closeModal('modalInquilino')"><i class="fas fa-arrow-left"></i> VOLTAR</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PAGAMENTOS -->
<div id="modalPagamentos" class="modal">
    <div class="card w-[450px]">
        <div class="flex justify-between items-center mb-6">
            <h3 id="pagamentosTitulo" class="font-black text-xl uppercase">Hist√≥rico 2026</h3>
            <button class="btn btn-ghost" onclick="closeModalPagamentos()"><i class="fas fa-times"></i> FECHAR</button>
        </div>



<button
  class="btn btn-primary w-full mb-4"
  onclick="avisarInquilinoAutomatico(findInquilinoById(currentInquilinoId))">
  üì≤ Avisar inquilino pelo WhatsApp
</button>



        <input type="hidden" id="pagInqId">
        <div id="gridPagamentos" class="grid grid-cols-4 gap-4">
            <!-- Renderizado via JS -->
        </div>
    </div>
</div>

<!-- MODAL BAIXA DE PAGAMENTO -->
<div id="modalBaixaPagamento" class="modal">
  <div class="card w-[380px]">
    
    <div class="flex justify-between items-center mb-4">
      <h3 id="baixaTitulo" class="font-black text-lg uppercase">
        Baixa de Pagamento
      </h3>
      <button class="btn btn-ghost" onclick="closeModal('modalBaixaPagamento')">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <p id="baixaSubtitulo" class="text-xs text-slate-500 mb-4">
      <!-- Inquilino / Unidade -->
    </p>

    <div class="space-y-3">

      <div>
     <label class="text-xs font-bold">Aluguel pago (R$)</label>
<input
  id="bpAluguel"
  type="number"
  step="0.01"
  class="input"
  oninput="atualizarTotalBaixa()">


      </div>

      <div>
        <label class="text-xs font-bold">Juros / Multa (R$)</label>
<input
  id="bpJuros"
  type="number"
  step="0.01"
  class="input"
  value="0"
  oninput="atualizarTotalBaixa()">


      </div>

      <div>
        <label class="text-xs font-bold">Data do pagamento</label>
        <input id="bpData" type="date" class="input">
      </div>

      <div class="bg-slate-50 p-3 rounded-lg border text-center">
        <p class="text-xs text-slate-400 uppercase font-bold">Total recebido</p>
        <p id="bpTotal" class="text-xl font-black text-slate-800">R$ 0,00</p>
      </div>

    </div>

    <div class="flex gap-2 mt-6">
     <button
  class="btn btn-primary flex-1 justify-center"
  onclick="confirmarPagamento()">
  Confirmar pagamento
</button>

      <button class="btn btn-ghost" onclick="closeModal('modalBaixaPagamento')">
        Cancelar
      </button>
    </div>

  </div>
</div>


<script>

let db = { predios: [] };
    let currentBase64 = "";
    let currentViewingPredioId = null; 
    const MESES = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    const HOJE = new Date();
 
    document.getElementById('inqArquivo').addEventListener('change', function(e) {
        const file = e.target.files;
        const reader = new FileReader();
        reader.onloadend = () => currentBase64 = reader.result;
        if(file) reader.readAsDataURL(file);
    });
    
async function save() {
  gerarContasReceber();
  await salvarNoSupabase();
  render();
}


    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { 
        document.getElementById(id).style.display = 'none'; 
        currentBase64 = ""; 
        render(); 
    }
    
    function closeModalPagamentos() {
        closeModal('modalPagamentos');
        if (currentViewingPredioId) {
            viewPredio(currentViewingPredioId); 
        }
    }

  async function addPredio() {

  const nome = document.getElementById('pNome').value;
  const unidadesTxt = document.getElementById('pUnidades').value;

  if (!nome || !unidadesTxt) {
    alert("Preencha nome e unidades");
    return;
  }

  const id = Date.now();

  const { error } = await supabaseClient
    .from('predios')
    .insert({
      id: id,
      nome: nome
    });

  if (error) {
    console.error("Erro ao salvar pr√©dio:", error);
    alert("Erro ao salvar no Supabase (veja o console)");
    return;
  }

  // limpa formul√°rio
  document.getElementById('pNome').value = '';
  document.getElementById('pUnidades').value = '';

  closeModal('modalPredio');

  // recarrega tudo do Supabase
  await carregarPrediosDoSupabase();
}

    function viewPredio(predioId) {
        currentViewingPredioId = predioId; 
        const p = db.predios.find(x => x.id === predioId);
        document.getElementById('detalheTitulo').innerText = p.nome;
        const lista = document.getElementById('listaUnidades');
        lista.innerHTML = p.unidades.map(u => {
            let isLate = false;
            if (u.inquilino && u.inquilino.pagamentos) {
                const mesAtual = HOJE.getMonth();
                const diaVenc = parseInt(u.inquilino.venc);
                if (!u.inquilino.pagamentos[mesAtual] && HOJE.getDate() > diaVenc) {
                    isLate = true;
                }
            }

const statusTag =
  u.status === 'vago'
    ? '<span class="tag tag-free">Vago</span>'
    : '<span class="tag tag-occupied">Ocupado</span>';

let financeiroTag = '<span class="text-slate-300">‚Äî</span>';

if (u.status === 'ocupado' && u.inquilino && u.inquilino.pagamentos) {
  const mesAtual = HOJE.getMonth();
  const diaVenc = parseInt(u.inquilino.venc);

  const pagamentoMes = u.inquilino.pagamentos[mesAtual];

if (pagamentoMes && pagamentoMes.pago === true) {
  financeiroTag = '<span class="tag tag-free">Pago</span>';
} else if (HOJE.getDate() > diaVenc) {
  financeiroTag = '<span class="tag tag-late">Inadimplente</span>';
}

}

            
            // Renderiza o link ou o tra√ßo '-' se n√£o houver contrato
            const contratoBtn = u.inquilino && u.inquilino.contrato && u.inquilino.contrato.length > 10 ? 
                                `<a href="${u.inquilino.contrato}" target="_blank" class="text-blue-600 hover:underline font-semibold"><i class="fas fa-file-pdf"></i> Ver Contrato</a>` : '-';
            
            const inquilinoNome = u.inquilino ? `<span class="cursor-pointer text-blue-700 hover:underline font-medium" onclick="viewPagamentos('${u.inquilino.id}')">${u.inquilino.nome}</span>` : '<span class="text-slate-300 italic">Dispon√≠vel</span>';
            
            return `
                <tr class="border-b hover:bg-slate-50 transition text-sm">
                    <td class="py-4 font-bold text-slate-800">${u.nome}</td>
                    <td>${inquilinoNome}</td>
                    <td>${u.inquilino ? 'R$ '+parseFloat(u.inquilino.valor).toLocaleString('pt-BR') : '-'}</td>
                    <td>${u.inquilino ? 'Dia '+u.inquilino.venc : '-'}</td>
                    <td class="text-center">${statusTag}</td>
<td class="text-center">${financeiroTag}</td>

                    <td>${contratoBtn}</td> 
                    <td class="text-right">
                        <button onclick="editInquilino(${p.id}, '${u.id}')" class="text-blue-600 font-black text-xs uppercase hover:underline">
                            <i class="fas fa-edit"></i> ${u.inquilino ? 'Editar' : 'Alugar'}
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        openModal('modalDetalhe');
    }

    function editInquilino(predioId, unidadeId) {
        closeModal('modalDetalhe'); 
        const p = db.predios.find(x => x.id === predioId);
        const u = p.unidades.find(x => x.id === unidadeId);
        
        document.getElementById('viewContrato').classList.add('hidden');
        document.getElementById('viewContrato').querySelector('a').href = '#';
        document.getElementById('inqArquivo').value = ''; // Limpa o input de arquivo visualmente

        document.getElementById('inqPredioId').value = predioId;
        document.getElementById('inqUnidadeId').value = unidadeId;
        document.getElementById('inqTitulo').innerText = u.nome;

        if(u.inquilino) {
            document.getElementById('inqNome').value = u.inquilino.nome;
            document.getElementById('inqValor').value = u.inquilino.valor;
            document.getElementById('inqVenc').value = u.inquilino.venc;
document.getElementById('inqCaucao').value = u.inquilino.caucao || 0;
            document.getElementById('btnVacar').style.display = 'block';
            if(u.inquilino.contrato) {
                document.getElementById('viewContrato').classList.remove('hidden');
                document.getElementById('viewContrato').querySelector('a').href = u.inquilino.contrato;
            }
        } else {
            document.getElementById('inqNome').value = ''; document.getElementById('inqValor').value = '';
            document.getElementById('inqVenc').value = ''; document.getElementById('btnVacar').style.display = 'none';
        }
        openModal('modalInquilino');
    }

    function saveInquilino() {
        const pId = parseInt(document.getElementById('inqPredioId').value);
        const uId = document.getElementById('inqUnidadeId').value;
        const p = db.predios.find(x => x.id === pId);
        const u = p.unidades.find(x => x.id === uId);
        const pagamentos = u.inquilino?.pagamentos || 
  Array.from({ length: 12 }, () => ({ pago: false }));

     u.inquilino = {
  id: u.inquilino?.id || Math.random().toString(36).substr(2, 9),
  nome: document.getElementById('inqNome').value,
  telefone: document.getElementById('inqTelefone').value,
  valor: document.getElementById('inqValor').value,
  venc: document.getElementById('inqVenc').value,
  caucao: parseFloat(document.getElementById('inqCaucao').value) || 0,
  contrato: currentBase64 || (u.inquilino ? u.inquilino.contrato : ""),
  pagamentos: pagamentos
};


// ================================
// REGISTRO DE CAU√á√ÉO (FINANCEIRO)
// ================================

// ================================
// REGISTRO DE CAU√á√ÉO (FINANCEIRO)
// ================================
const caucaoValor = parseFloat(document.getElementById('inqCaucao').value) || 0;

if (caucaoValor > 0) {

  if (!db.financeiro.lancamentos) {
    db.financeiro.lancamentos = [];
  }

  const jaExisteCaucao = db.financeiro.lancamentos.some(l =>
    l.tipo === 'receita' &&
    l.categoria === 'caucao' &&
    l.predioId === pId &&
    l.unidade === u.nome
  );

  if (!jaExisteCaucao) {
    db.financeiro.lancamentos.push({
      id: Date.now(),
      tipo: 'receita',
      categoria: 'caucao',
      valor: caucaoValor,
      data: new Date().toISOString().split('T')[0],
      mes: new Date().getMonth(),
      ano: 2026,
      predioId: pId,
      unidade: u.nome,
      inquilinoNome: document.getElementById('inqNome').value,
      observacao: 'Cau√ß√£o contratual'
    });
  }
}

        u.status = 'ocupado';
        closeModal('modalInquilino');
        save();
        viewPredio(pId);
    }

    function vacarUnidade() {
        if(!confirm("Remover inquilino desta unidade?")) return;
        const pId = parseInt(document.getElementById('inqPredioId').value);
        const uId = document.getElementById('inqUnidadeId').value;
        const p = db.predios.find(x => x.id === pId);
        const u = p.unidades.find(x => x.id === uId);
        u.inquilino = null;
        u.status = 'vago';
        closeModal('modalInquilino');
        save();
        viewPredio(pId);
    }

    let currentInquilinoId = null;

    function viewPagamentos(inquilinoId) {
        currentInquilinoId = inquilinoId;
        const inq = findInquilinoById(inquilinoId);
        document.getElementById('pagamentosTitulo').innerText = `Hist√≥rico de ${inq.nome.split(' ')}`;
        renderPagamentosGrid(inq);
        openModal('modalPagamentos');
    }
    
    function togglePagamento(mesIndex) {
        const inq = findInquilinoById(currentInquilinoId);
        inq.pagamentos[mesIndex] = !inq.pagamentos[mesIndex];
        save(); 
        renderPagamentosGrid(inq); 
    }

    function renderPagamentosGrid(inq) {
  const grid = document.getElementById('gridPagamentos');
  grid.innerHTML = '';

  inq.pagamentos.forEach((pag, index) => {
    const mesNome = MESES[index];

    const pago = pag && pag.pago === true;

    const div = document.createElement('div');
    div.className = `payment-month p-3 text-center rounded-lg shadow-sm ${
      pago ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'
    }`;

    div.innerHTML = `
      <p class="font-bold">${mesNome}</p>
      <p class="text-xs">${pago ? 'Pago' : 'Pendente'}</p>
    `;

    div.onclick = () => {
      if (pago) {
        reverterPagamento(index);
      } else {
        abrirBaixaPagamento(index);
      }
    };

    grid.appendChild(div);
  });
}


    function findInquilinoById(id) {
        for (const predio of db.predios) {
            for (const unidade of predio.unidades) {
                if (unidade.inquilino && unidade.inquilino.id === id) {
                    return unidade.inquilino;
                }
            }
        }
        return null;
    }

function editarPredio(predioId){
  const p = db.predios.find(x => x.id === predioId);
  const novoNome = prompt("Digite o novo nome do pr√©dio:", p.nome);
  if(!novoNome) return;
  p.nome = novoNome;
  save();
}



function adicionarUnidade(predioId){
  const p = db.predios.find(x => x.id === predioId);

  const nome = prompt("Nome do apartamento (ex: Apto 105):");
  if(!nome) return;

  p.unidades.push({
    id: Math.random().toString(36).substr(2,9),
    nome: nome,
    status: 'vago',
    inquilino: null
  });

  save();
}


    function render() {
        const grid = document.getElementById('gridPredios');
        grid.innerHTML = db.predios.map(p => {
            const livres = p.unidades.filter(u => u.status === 'vago').length;
            let inadimplentesCount = 0;
            p.unidades.forEach(u => {
                if (u.inquilino && u.inquilino.pagamentos) {
                    const mesAtual = HOJE.getMonth();
                    const diaVenc = parseInt(u.inquilino.venc);
                    if (!u.inquilino.pagamentos[mesAtual] && HOJE.getDate() > diaVenc) {
                        inadimplentesCount++;
                    }
                }
            });
            const ocupados = p.unidades.length - livres;
            return `
            <div class="card relative cursor-pointer hover:shadow-xl transition"
     onclick="viewPredio(${p.id})">
<div class="absolute top-10 right-3 flex gap-2">
  <button
    onclick="event.stopPropagation(); editarPredio(${p.id})"
    class="text-slate-400 hover:text-blue-600 text-sm"
    title="Editar pr√©dio">‚úèÔ∏è</button>

  <button
    onclick="event.stopPropagation(); adicionarUnidade(${p.id})"
    class="text-slate-400 hover:text-green-600 text-sm"
    title="Adicionar apartamento">‚ûï</button>

  <button
    onclick="event.stopPropagation(); removerPredio(${p.id})"
    class="text-slate-400 hover:text-red-600 text-sm"
    title="Apagar pr√©dio">üóëÔ∏è</button>
</div>



                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-lg font-black text-slate-800 uppercase tracking-tight">${p.nome}</h3>
                        <span class="text-[10px] bg-slate-100 text-slate-500 font-bold px-2 py-1 rounded">${p.unidades.length} UNID.</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <p class="text-[10px] font-bold text-blue-400 uppercase">Livres</p>
                            <p class="text-2xl font-black text-blue-900">${livres}</p>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg border border-amber-100">
                            <p class="text-[10px] font-bold text-amber-400 uppercase">Inadimplentes</p>
                            <p class="text-2xl font-black text-amber-900">${inadimplentesCount}</p>
                        </div>
                    </div>
                    <div class="mt-6 flex items-center justify-between text-xs font-bold text-slate-400 uppercase">
                        <span>Ocupa√ß√£o: ${((ocupados/p.unidades.length)*100).toFixed(0)}%</span>
                        <i class="fas fa-arrow-right text-blue-600"></i>
                    </div>
                </div>
            `;
        }).join('');
    }

    render();

 
function montarContratoTexto() {
return `
CONTRATO DE LOCA√á√ÉO DE IM√ìVEL PARA FINS RESIDENCIAIS


Por este instrumento particular, as partes a seguir nominadas celebram o CONTRATO DE LOCA√á√ÉO RESIDENCIAL, na forma da Lei 8.245/91, alterada pela Lei 12.112/09, conforme cl√°usulas e condi√ß√µes que a seguir reciprocamente aceitam e outorgam livremente, elegendo o Sistema de Assinatura Eletr√¥nica como meio apto e plenamente v√°lido para firmar o exato cumprimento das obriga√ß√µes aqui assumidas, renunciando, ainda, a eventual direito de rep√∫dio da validade desta assinatura.


CL√ÅUSULA PRIMEIRA ‚Äì DAS PARTES:

LOCADOR(A) ‚Äì PRB EMPREENDIMENTOS IMOBILIARIOS EIRELI, pessoa jur√≠dica de direito privado, devidamente inscrita no CNPJ n¬∫. 35.059.055/0001-51, neste ato representada por seu s√≥cio, Paulo Glaydson Rocha Bandeira, brasileiro, casado, inscrito no CPF n¬∫. 840.563.633-15.


LOCAT√ÅRIO(A) ‚Äì ${inqNome.value}, ${inqNacionalidade.value}, ${inqProfissao.value}, portador(a) da C√©dula de Identidade ${inqRG.value}, inscrito(a) no CPF ${inqCPF.value}, residente e domiciliado(a) √† ${inqEndereco.value}.


GARANTIA LOCAT√çCIA (X) CAU√á√ÉO: Para garantia do fiel cumprimento de todas as obriga√ß√µes contratuais assumidas neste instrumento, o LOCAT√ÅRIO presta, neste ato, cau√ß√£o em dinheiro no valor de R$ ${inqCaucao.value}, equivalente a 2 (dois) meses de aluguel. O valor da cau√ß√£o ser√° depositado na conta da empresa LOCADORA e ser√° devolvido ao LOCAT√ÅRIO ao final do contrato, desde que cumpridas todas as obriga√ß√µes contratuais e entregue o im√≥vel nas mesmas condi√ß√µes de recebimento, conforme Termo de Vistoria. A cau√ß√£o n√£o poder√° ser utilizada para pagamento de alugu√©is, taxas ou quaisquer outros encargos durante a vig√™ncia do contrato, destinando-se exclusivamente √† garantia de cumprimento das obriga√ß√µes contratuais. Em caso de inadimplemento das obriga√ß√µes contratuais pelo LOCAT√ÅRIO, o LOCADOR poder√° utilizar o valor da cau√ß√£o para cobertura dos d√©bitos pendentes, independentemente de aviso ou notifica√ß√£o judicial ou extrajudicial.


CL√ÅUSULA SEGUNDA ‚Äì OBJETO DA LOCA√á√ÉO: 

Tem-se por objeto da loca√ß√£o o IM√ìVEL situado na Rua Pedra Branca 170 Apto 04, Bairro Joaquim T√°vora, Fortaleza/CE, CEP: 60135-110, destinando-se exclusivamente para fins Residenciais, nas condi√ß√µes constantes no TERMO DE VISTORIA anexo que faz parte integrante do presente contrato.


CL√ÅUSULA TERCEIRA ‚Äì PRAZO DE LOCA√á√ÉO: 

O prazo da presente loca√ß√£o ser√° de 12 (doze) meses, iniciando no dia ${new Date().toLocaleDateString('pt-BR')} com termino ap√≥s 12 (doze) meses. Ap√≥s o termino do prazo, o contrato ser√° renovado automaticamente, vigorando por prazo indeterminado. 

Par√°grafo Primeiro ‚Äì Caso o presente contrato venha a ser rescindido pelo LOCAT√ÅRIO durante os primeiros 12 (doze) meses, este dever√° realizar o envio de notifica√ß√£o formal/escrita, com anteced√™ncia de 30 (trinta) dias, ocasi√£o em que ser√° calculada e aplicada multa de 2 (dois) meses de aluguel.

Par√°grafo Segundo ‚Äì Escoado o prazo da loca√ß√£o ora fixado ou rescindida a loca√ß√£o por qualquer outro motivo, obriga-se o LOCAT√ÅRIO a entregar o IM√ìVEL em condi√ß√µes de habitabilidade, devidamente limpo e pintado, com suas instala√ß√µes em perfeito estado de uso.


CL√ÅUSULA QUARTA ‚Äì VALOR DA LOCA√á√ÉO: 

O aluguel mensal, livremente convencionado √©, nesta data, de R$ ${inqValor.value}, a ser pago todo dia ${inqVenc.value}.

Par√°grafo Primeiro ‚Äì O aluguel estabelecido no "caput" desta cl√°usula dever√° ser pago atrav√©s de boleto banc√°rio que ser√° enviado diretamente ao LOCAT√ÅRIO. O pagamento dever√° ser efetuado onde o LOCADOR indicar, por escrito, independentemente de aviso ou cobran√ßa, at√© o √∫ltimo dia de cada m√™s, sempre dentro do hor√°rio banc√°rio.

Par√°grafo Segundo ‚Äì Caso o pagamento n√£o seja realizado at√© a data do vencimento, ser√° acrescido multa morat√≥ria de 10%, sem preju√≠zo dos encargos morat√≥rios previstos na Cl√°usula S√©tima.

Par√°grafo Terceiro ‚Äì O aluguel mensal acima pactuado ser√° reajustado, automaticamente, a cada 12 meses, sendo a data base a de sua celebra√ß√£o, aplicando-se como √≠ndice o IGP-M da FGV, ou, n√£o sendo este calculado, qualquer √≠ndice de pre√ßos que o substitua e que reflita a varia√ß√£o dos pre√ßos, no per√≠odo do reajuste.

Par√°grafo Quarto ‚Äì Se, em virtude de lei subsequente, vier a ser admitida a corre√ß√£o do valor do aluguel em periodicidade inferior a prevista na legisla√ß√£o vigente, concordam as partes que a corre√ß√£o do aluguel e o seu indexador passar√° automaticamente a ser feita no menor prazo permitido pela lei posterior.

Par√°grafo Quinto ‚Äì No ato da desocupa√ß√£o do im√≥vel, o LOCADOR realizar√° vistoria no local para verificar se o im√≥vel est√° em perfeitas condi√ß√µes de uso. Caso contr√°rio, ficar√° a LOCAT√ÅRIA obrigada a realizar os servi√ßos ou indenizar o valor necess√°rio √† realiza√ß√£o dos mesmos, conforme or√ßamentos apresentados, sem preju√≠zo da multa contratual prevista neste contrato.


CL√ÅUSULA QUINTA ‚Äì OUTROS ENCARGOS: 

Correr√£o por conta do LOCAT√ÅRIO todas as despesas do im√≥vel, inclusive tributos, condom√≠nio, energia el√©trica, √°gua, esgoto e g√°s.


CL√ÅUSULA SEXTA ‚Äì SEGURO CONTRA INC√äNDIO: 

Obriga-se ainda o LOCAT√ÅRIO a pagar anualmente o pr√™mio de seguro contra inc√™ndio do im√≥vel locado.


CL√ÅUSULA S√âTIMA ‚Äì √îNUS DA IMPONTUALIDADE: 

O aluguel e encargos n√£o pagos na data aprazada ficar√£o sujeitos √† multa, juros, corre√ß√£o monet√°ria e honor√°rios advocat√≠cios, conforme previsto neste contrato.


CL√ÅUSULA OITAVA ‚Äì BENFEITORIAS 

O LOCAT√ÅRIO n√£o poder√° fazer qualquer modifica√ß√£o no im√≥vel locado sem autoriza√ß√£o expressa do LOCADOR.


CL√ÅUSULA NONA ‚Äì RESTITUI√á√ÉO DO IM√ìVEL

Findo o prazo da loca√ß√£o, o im√≥vel ser√° restitu√≠do em perfeitas condi√ß√µes de uso.


CL√ÅUSULA D√âCIMA ‚Äì DA VISTORIA

O LOCAT√ÅRIO permitir√° a vistoria do im√≥vel mediante aviso pr√©vio.


CL√ÅUSULA D√âCIMA PRIMEIRA ‚Äì DA OCORR√äNCIA DE DESAPROPRIA√á√ÉO OU SINISTRO

Aplicam-se as disposi√ß√µes legais em caso de desapropria√ß√£o ou sinistro.


CL√ÅUSULA D√âCIMA SEGUNDA ‚Äì HONOR√ÅRIOS

Os honor√°rios advocat√≠cios ser√£o de 20% sobre o montante devido.


CL√ÅUSULA D√âCIMA TERCEIRA ‚Äì PROCEDIMENTOS JUDICIAIS

As comunica√ß√µes processuais poder√£o ser realizadas por via postal.


CL√ÅUSULA D√âCIMA QUARTA ‚Äì DO CUMPRIMENTO DAS OBRIGA√á√ïES LEGAIS

O LOCAT√ÅRIO compromete-se a cumprir as normas legais e condominiais.


CL√ÅUSULA D√âCIMA QUINTA ‚Äì MULTA POR INFRA√á√ÉO CONTRATUAL 

O descumprimento de cl√°usula contratual implicar√° multa equivalente a dois meses de aluguel.


CL√ÅUSULA D√âCIMA SEXTA ‚Äì DO DIREITO DE PREFER√äNCIA

O LOCAT√ÅRIO ter√° direito de prefer√™ncia na aquisi√ß√£o do im√≥vel.


CL√ÅUSULA D√âCIMA S√âTIMA ‚Äì DA VEDA√á√ÉO A SUBLOCA√á√ÉO

√â vedada a subloca√ß√£o sem autoriza√ß√£o do LOCADOR.


CL√ÅUSULA D√âCIMA OITAVA ‚Äì DA OBRIGA√á√ÉO DE PAGAMENTO EM CASO DE INTERRUP√á√ÉO DE SERVI√áOS:

Interrup√ß√µes de servi√ßos n√£o eximem o pagamento do aluguel.


CL√ÅUSULA D√âCIMA NONA ‚Äì DECLARA√á√ÉO DE VERACIDADE DAS INFORMA√á√ïES

O LOCAT√ÅRIO declara a veracidade das informa√ß√µes prestadas.


CL√ÅUSULA VIG√âSIMA ‚Äì FORO 

Fica eleito o foro da cidade de Fortaleza/CE.


Fortaleza/CE, ${new Date().toLocaleDateString('pt-BR')}



PRB EMPREENDIMENTOS IMOBILIARIOS EIRELI  
LOCADOR


${inqNome.value}  
LOCAT√ÅRIO



TESTEMUNHAS:

Nome:
CPF:

Nome:
CPF:
`;
}




function gerarContratoPDF() {
    const { jsPDF } = window.jspdf;

    const doc = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: "a4"
    });


    const texto = montarContratoTexto();

    doc.setFont("Times", "Normal");
    doc.setFontSize(11);

    const margemEsquerda = 20;
    const margemTopo = 20;
    const margemInferior = 20;

    const larguraPagina = 210;
    const alturaPagina = 297;

    const larguraUtil = larguraPagina - margemEsquerda * 2;
    const alturaUtil = alturaPagina - margemTopo - margemInferior;

    const linhas = doc.splitTextToSize(texto, larguraUtil);

    let y = margemTopo;

    for (let i = 0; i < linhas.length; i++) {
        if (y > alturaUtil) {
            doc.addPage();
            y = margemTopo;
        }
        doc.text(linhas[i], margemEsquerda, y);
        y += 6;
    }

    doc.save(`Contrato_${inqNome.value || 'Locacao'}.pdf`);
}

function atualizarTotalBaixa() {
  const aluguel = document.getElementById('bpAluguel').value;
  const juros = document.getElementById('bpJuros').value;

  const aluguelNum = parseFloat(aluguel) || 0;
  const jurosNum = parseFloat(juros) || 0;

  const total = aluguelNum + jurosNum;

  document.getElementById('bpTotal').innerText =
    'R$ ' + total.toLocaleString('pt-BR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
}

function abrirBaixaPagamento(mesIndex) {
  const inq = findInquilinoById(currentInquilinoId);
  if (!inq) return;

  // guarda o m√™s que est√° sendo baixado
  window.mesBaixaAtual = mesIndex;

  // preenche valores padr√£o
  document.getElementById('bpAluguel').value = inq.valor || 0;
  document.getElementById('bpJuros').value = 0;

  // data de hoje
  document.getElementById('bpData').value =
    new Date().toISOString().split('T')[0];

  // t√≠tulo informativo
  document.getElementById('baixaSubtitulo').innerText =
    `${MESES[mesIndex]} ‚Ä¢ ${inq.nome}`;

  // atualiza total
  atualizarTotalBaixa();

  // abre o modal
  openModal('modalBaixaPagamento');
}

function confirmarPagamento() {
  const inq = findInquilinoById(currentInquilinoId);
  if (!inq) return;

  const mes = window.mesBaixaAtual;

  const aluguel = parseFloat(document.getElementById('bpAluguel').value) || 0;
  const juros = parseFloat(document.getElementById('bpJuros').value) || 0;
  const data = document.getElementById('bpData').value || null;

  inq.pagamentos[mes] = {
    pago: true,
    aluguel: aluguel,
    juros: juros,
    data: data
  };

// ================================
// REGISTRO FINANCEIRO (HIST√ìRICO)
// ================================

if (!db.financeiro.lancamentos) {
  db.financeiro.lancamentos = [];
}

// aluguel
db.financeiro.lancamentos.push({
  id: Date.now(),
  tipo: 'receita',
  categoria: 'aluguel',
  valor: aluguel,
  data: data,
  mes: mes,
  ano: 2026,
  predioId: currentViewingPredioId,
  unidade: null,
  inquilinoNome: inq.nome,
  observacao: 'Aluguel mensal'
});

// juros / multa
if (juros > 0) {
  db.financeiro.lancamentos.push({
    id: Date.now() + 1,
    tipo: 'receita',
    categoria: 'juros',
    valor: juros,
    data: data,
    mes: mes,
    ano: 2026,
    predioId: currentViewingPredioId,
    unidade: null,
    inquilinoNome: inq.nome,
    observacao: 'Juros / multa'
  });
}



  save();
  closeModal('modalBaixaPagamento');
  renderPagamentosGrid(inq);
}



function reverterPagamento(mesIndex) {
  const inq = findInquilinoById(currentInquilinoId);
  if (!inq) return;

  const mesNome = MESES[mesIndex];

  if (!confirm(`Deseja reverter o pagamento de ${mesNome}?`)) return;

  inq.pagamentos[mesIndex] = { pago: false };

  save();
  renderPagamentosGrid(inq);
}

function getFiltrosFinanceiro() {
  return {
    mes: document.getElementById('filtroMes').value,
    ano: document.getElementById('filtroAno').value,
    predio: document.getElementById('filtroPredio').value
  };
}

function calcularFinanceiro(){

  const { mes, ano, predio } = getFiltrosFinanceiro();

  let alugueisRecebidos = 0;
  let jurosRecebidos = 0;
  let caucaoSaldo = 0;
  let contasPagar = 0;
let inadimplencia = 0;
let contasReceber = 0;
let lucro = 0;
let caucaoFiltrada = 0;


// ================================
// CAU√á√ÉO ‚Äî SOMA REAL POR INQUILINO
// ================================
caucaoSaldo = 0;

db.predios.forEach(predio => {
  predio.unidades.forEach(u => {
    if (u.status === 'ocupado' && u.inquilino) {
      caucaoSaldo += parseFloat(u.inquilino.caucao || 0);


    }
  });
});

// ================================
// INADIMPL√äNCIA REAL (VENCEU E N√ÉO PAGOU)
// ================================
inadimplencia = 0;

db.predios.forEach(predio => {
  predio.unidades.forEach(u => {
    if (u.status === 'ocupado' && u.inquilino) {

      const mesAtual = HOJE.getMonth();
      const diaVenc = parseInt(u.inquilino.venc);

      const pagamentoMes = u.inquilino.pagamentos[mesAtual];

      const naoPago = !pagamentoMes || pagamentoMes.pago !== true;
      const venceu = HOJE.getDate() > diaVenc;

      if (naoPago && venceu) {
        inadimplencia += parseFloat(u.inquilino.valor || 0);
      }
    }
  });
});


  // ================================
  // RECEITAS E DESPESAS (HIST√ìRICO REAL)
  // ================================
  if (!db.financeiro.lancamentos) {
    db.financeiro.lancamentos = [];
  }

  db.financeiro.lancamentos.forEach(l => {

    if (mes !== 'all' && l.mes != mes) return;
if (ano && l.ano != ano) return;
if (predio !== 'all' && l.predioId && l.predioId != predio) return;


    if (l.tipo === 'receita') {

      if (l.categoria === 'aluguel') {
        alugueisRecebidos += l.valor;
      }

if (l.categoria === 'caucao') {
  caucaoFiltrada += l.valor;
}

      if (l.categoria === 'juros') {
        jurosRecebidos += l.valor;
      }



      // ================================

    }

    if (l.tipo === 'despesa') {
      contasPagar += l.valor;
    }
  });

  // ================================
  // CONTAS A RECEBER / INADIMPL√äNCIA
  // ================================
// ================================
// CONTAS A RECEBER (ABERTO)
// ================================
db.financeiro.contasReceber.forEach(c => {

  if (mes !== 'all' && c.mes != mes) return;
  if (ano && c.ano != ano) return;
  if (predio !== 'all' && c.predioId != predio) return;

  if (c.status === 'aberto') {
    contasReceber += c.valor;
  }
});


  document.getElementById('finAluguelRecebido').innerText =
    'R$ ' + alugueisRecebidos.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

  document.getElementById('finJuros').innerText =
    'R$ ' + jurosRecebidos.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

  document.getElementById('finCaucao').innerText =
    'R$ ' + caucaoSaldo.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

document.getElementById('finPagar').innerText =
  'R$ ' + contasPagar.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

document.getElementById('finInadimplencia').innerText =
  'R$ ' + inadimplencia.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

document.getElementById('finReceber').innerText =
  'R$ ' + contasReceber.toLocaleString('pt-BR', {
    minimumFractionDigits: 2
  });

// ================================
// LUCRO
// ================================
lucro = alugueisRecebidos + caucaoFiltrada - contasPagar;

document.getElementById('finLucro').innerText =
  'R$ ' + lucro.toLocaleString('pt-BR', {
    minimumFractionDigits: 2
  });


}

function carregarPrediosDespesa() {
  const select = document.getElementById('despPredio');
  if (!select) return;

  // limpa antes
  select.innerHTML = '<option value="">Selecione um pr√©dio</option>';

  db.predios.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.innerText = p.nome;
    select.appendChild(opt);
  });
}


function carregarFiltroPredios(){
  const select = document.getElementById('filtroPredio');
  select.innerHTML = '<option value="all">Todos os pr√©dios</option>';

  db.predios.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.innerText = p.nome;
    select.appendChild(opt);
  });
}

function abrirFinanceiro(){
  gerarContasReceber(); // üî• garante dados atualizados

  document.getElementById('viewPortfolio').style.display = 'none';
  document.getElementById('viewFinanceiro').classList.remove('hidden');

  carregarFiltroPredios();
  calcularFinanceiro();
renderDespesas();

}

function voltarParaPortfolio(){


// GARANTE ESTADO INICIAL CORRETO
document.getElementById('viewPortfolio').style.display = 'block';
document.getElementById('viewFinanceiro').classList.add('hidden');

}

// ================================
// ESTADO INICIAL DA TELA (FOR√áADO)
// ================================
window.onload = async function () {
  document.getElementById('viewPortfolio').style.display = 'block';
  document.getElementById('viewFinanceiro').classList.add('hidden');

  await carregarPrediosDoSupabase();
};

function gerarContasReceber(){
  db.financeiro.contasReceber = [];

  db.predios.forEach(predio => {
    predio.unidades.forEach(u => {
      if(u.status === 'ocupado' && u.inquilino){
        for(let mes = 0; mes < 12; mes++){
          db.financeiro.contasReceber.push({
            predioId: predio.id,
            unidade: u.nome,
            inquilino: u.inquilino.nome,
            mes,
            ano: 2026,
            valor: parseFloat(u.inquilino.valor),
            juros: 0,
status:
  u.inquilino.pagamentos[mes] &&
  u.inquilino.pagamentos[mes].pago === true
    ? 'pago'
    : 'aberto'
          });
        }
      }
    });
  });
}

// INICIALIZA O SISTEMA AO ABRIR A P√ÅGINA

// 1Ô∏è‚É£ garante que o financeiro existe
if(!db.financeiro){
  db.financeiro = {
    contasReceber: [],
    contasPagar: [],
    caixa: []
  };
}

// 2Ô∏è‚É£ gera as contas a receber
gerarContasReceber();

// 3Ô∏è‚É£ s√≥ depois desenha a tela
render();

// ================================
// CONTAS A PAGAR (DESPESAS)
// ================================
function adicionarDespesa({
  descricao,
  valor,
  data,
  predioId = null,
  categoria = 'geral'
}) {

  if (!db.financeiro.lancamentos) {
    db.financeiro.lancamentos = [];
  }

  const d = new Date(data);

  db.financeiro.lancamentos.push({
    id: Date.now(),
    tipo: 'despesa',
    categoria: categoria,
    valor: parseFloat(valor),
    data: data,
    mes: d.getMonth(),
    ano: d.getFullYear(),
    predioId: predioId,
    observacao: descricao
  });

  save();
}

function salvarDespesa(){

if (window.despesaEditandoId) {

  const d = db.financeiro.lancamentos.find(
    l => l.id === window.despesaEditandoId
  );

  d.observacao = descricao;
  d.categoria = categoria;
  d.valor = valor;
  d.data = data;
  d.mes = new Date(data).getMonth();
  d.ano = new Date(data).getFullYear();
  d.predioId = predioId;
  d.fornecedor = fornecedor;

  window.despesaEditandoId = null;

  closeModal('modalDespesa');
  save();
  aplicarFiltros();
  return;
}

  const descricao = document.getElementById('despDescricao').value;
  const categoria = document.getElementById('despCategoria').value;
  const valor = parseFloat(document.getElementById('despValor').value);
  const data = document.getElementById('despData').value;
  const fornecedor = document.getElementById('despFornecedor').value;
  const predioId = document.getElementById('despPredio').value || null;

  if(!descricao || !valor || !data){
    alert("Preencha descri√ß√£o, valor e data.");
    return;
  }

  if (!db.financeiro.lancamentos) {
    db.financeiro.lancamentos = [];
  }

  const d = new Date(data);

  db.financeiro.lancamentos.push({
    id: Date.now(),
    tipo: 'despesa',
    categoria: categoria,
    valor: valor,
    data: data,
    mes: d.getMonth(),
    ano: d.getFullYear(),
    predioId: predioId,
    fornecedor: fornecedor,
    observacao: descricao
  });

  closeModal('modalDespesa');
  save();
  calcularFinanceiro();
renderDespesas();

}

function renderDespesas(){
const { mes, ano, predio } = getFiltrosFinanceiro();

  const tbody = document.getElementById('listaDespesas');
  if(!tbody) return;

  tbody.innerHTML = '';

  if (!db.financeiro.lancamentos) return;

  const despesas = db.financeiro.lancamentos.filter(l => {

  if (l.tipo !== 'despesa') return false;

  if (mes !== 'all' && l.mes != mes) return false;
  if (ano && l.ano != ano) return false;
  if (predio !== 'all' && l.predioId != predio) return false;

  return true;
});


  despesas.forEach(d => {
    const tr = document.createElement('tr');
    tr.className = 'border-b hover:bg-slate-50';

    const predioNome = d.predioId
  ? (db.predios.find(p => p.id == d.predioId)?.nome || '‚Äî')
  : '‚Äî';

tr.innerHTML = `
  <td class="p-3">${d.observacao || '-'}</td>
  <td class="p-3 font-medium">${predioNome}</td>
  <td class="p-3 capitalize">${d.categoria}</td>
  <td class="p-3">${new Date(d.data).toLocaleDateString('pt-BR')}</td>
  <td class="p-3 text-right font-bold text-red-600">
    R$ ${d.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
  </td>
  <td class="p-3 text-center whitespace-nowrap">
    <button
      onclick="editarDespesa(${d.id})"
      class="text-blue-600 hover:text-blue-800 mr-2"
      title="Editar">
      ‚úèÔ∏è
    </button>
    <button
      onclick="excluirDespesa(${d.id})"
      class="text-red-600 hover:text-red-800"
      title="Excluir">
      üóëÔ∏è
    </button>
  </td>
`;


    tbody.appendChild(tr);
  });
}

function abrirModalDespesa() {
  carregarPrediosDespesa(); // üî• carrega os pr√©dios
  openModal('modalDespesa');
}

function aplicarFiltros() {
  calcularFinanceiro();
  renderDespesas();
}

function excluirDespesa(id){
  if(!confirm("Deseja realmente excluir esta despesa?")) return;

  db.financeiro.lancamentos = db.financeiro.lancamentos.filter(
    l => l.id !== id
  );

  save();
  aplicarFiltros();
}

function editarDespesa(id){

  const d = db.financeiro.lancamentos.find(l => l.id === id);
  if(!d) return;

  // preenche campos
  document.getElementById('despDescricao').value = d.observacao || '';
  document.getElementById('despCategoria').value = d.categoria;
  document.getElementById('despValor').value = d.valor;
  document.getElementById('despData').value = d.data;
  document.getElementById('despFornecedor').value = d.fornecedor || '';
  document.getElementById('despPredio').value = d.predioId || '';

  // guarda ID da despesa sendo editada
  window.despesaEditandoId = id;

  openModal('modalDespesa');
}

function avisarInquilinoWhatsApp(nome, telefone, valor, mesIndex, ano) {

  if (!telefone) {
    alert("Este inquilino n√£o tem telefone cadastrado.");
    return;
  }

  const telefoneLimpo = telefone.replace(/\D/g, '');

  const nomeMes = MESES[mesIndex]; // ‚Üê aqui est√° a corre√ß√£o

  const mensagem =
    `Ol√° ${nome}, tudo bem?\n\n` +
    `Seu aluguel referente a ${nomeMes}/${ano} no valor de R$ ${valor} ainda est√° em aberto.\n\n` +
    `Qualquer d√∫vida fico √† disposi√ß√£o.`;

  const url =
    `https://wa.me/55${telefoneLimpo}?text=${encodeURIComponent(mensagem)}`;

  window.open(url, '_blank');
}

function avisarInquilinoAutomatico(inq) {

  if (!inq || !inq.telefone) {
    alert("Inquilino sem telefone cadastrado.");
    return;
  }

  const hoje = HOJE;
  const mesAtual = hoje.getMonth();
  const diaHoje = hoje.getDate();
  const diaVenc = parseInt(inq.venc);
  const pagamentoMes = inq.pagamentos[mesAtual] || { pago: false };
  const pago = pagamentoMes && pagamentoMes.pago === true;

  if (pago) {
    alert("Este aluguel j√° est√° pago.");
    return;
  }

  const DIAS_AVISO = 5; // ‚¨ÖÔ∏è QUANTOS DIAS ANTES AVISA
  const diasRestantes = diaVenc - diaHoje;

  const telefoneLimpo = inq.telefone.replace(/\D/g, '');
  const nomeMes = MESES[mesAtual];

  let mensagem = '';

  // üî¥ CASO 1 ‚Äî ATRASADO
  if (diasRestantes < 0) {

    mensagem =
      `Ol√° ${inq.nome}, tudo bem?\n\n` +
      `Seu aluguel referente a ${nomeMes}/2026 no valor de R$ ${inq.valor} est√° vencido.\n\n` +
      `Por favor, nos informe sobre o pagamento.\n`;

  }
  // üü° CASO 2 ‚Äî VAI VENCER (AT√â X DIAS)
  else if (diasRestantes <= DIAS_AVISO) {

    mensagem =
      `Ol√° ${inq.nome}, tudo bem?\n\n` +
      `Seu aluguel de ${nomeMes}/2026 no valor de R$ ${inq.valor} vence em ${diasRestantes} dia(s).\n\n` +
      `Qualquer d√∫vida, ficamos √† disposi√ß√£o.\n`;

  }
  // üü¢ CASO 3 ‚Äî AINDA FALTA MUITO TEMPO
  else {
    alert("Este aluguel ainda n√£o est√° pr√≥ximo do vencimento.");
    return;
  }

  const url =
    `https://wa.me/55${telefoneLimpo}?text=${encodeURIComponent(mensagem)}`;

  window.open(url, '_blank');
}

function removerPredio(predioId) {

  const p = db.predios.find(x => x.id === predioId);
  if (!p) return;

  const confirmar = confirm(
    `Tem certeza que deseja excluir o pr√©dio "${p.nome}"?\n\n` +
    `‚ö†Ô∏è Isso ir√° remover TODAS as unidades e inquilinos deste pr√©dio.`
  );

  if (!confirmar) return;

  // remove o pr√©dio
  db.predios = db.predios.filter(x => x.id !== predioId);

  // salva no localStorage
  await salvarNoSupabase();

  // redesenha a tela
  render();
}

    async function testeSupabase() {

  const { data, error } = await supabaseClient
    .from('predios')
    .select('*');

  if (error) {
    console.error("Erro ao ler Supabase:", error);
  } else {
    console.log("Dados vindos do Supabase (predios):", data);
  }

}
testeSupabase();

    async function enviarPrimeiroPredioParaSupabase() {

  if (!db.predios.length) {
    alert("N√£o existe nenhum pr√©dio no banco local.");
    return;
  }

  const p = db.predios[0];

  const { error } = await supabaseClient
    .from('predios')
    .upsert({
      id: p.id,
      nome: p.nome
    });

  if (error) {
    console.error("Erro ao enviar pr√©dio:", error);
    alert("Erro ao enviar pr√©dio (veja o console)");
  } else {
    alert("Pr√©dio enviado com sucesso para o Supabase!");
  }
}
// enviarPrimeiroPredioParaSupabase();

async function carregarPrediosDoSupabase() {

  const { data, error } = await supabaseClient
    .from('predios')
    .select('*')
    .order('created_at', { ascending: true });

  if (error) {
    console.error("Erro ao carregar pr√©dios:", error);
    return;
  }

  // se n√£o tiver nada no Supabase, n√£o faz nada
  if (!data || !data.length) {
    console.log("Nenhum pr√©dio no Supabase ainda.");
    return;
  }

  // monta o db local a partir do Supabase
  db.predios = data.map(p => ({
    id: p.id,
    nome: p.nome,
    unidades: [] // por enquanto vazio
  }));

  // salva no localStorage para o resto do sistema funcionar
  await salvarNoSupabase();

  render();
}

async function salvarNoSupabase() {
  // Aqui voc√™ salva os dados no Supabase
  // Por enquanto, deixe como est√° (ser√° implementado depois)
  console.log('Dados salvos:', db);
}

async function carregarDoSupabase() {
  const { data, error } = await supabase.from('predios').select('*, unidades(*, inquilinos(*))');
  if (!error && data) {
    db.predios = data;
  }
}

    
</script>


<!-- MODAL NOVA DESPESA -->
<div id="modalDespesa" class="modal">
  <div class="card w-[420px]">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-black text-lg uppercase">Nova despesa</h3>
      <button class="btn btn-ghost" onclick="closeModal('modalDespesa')">‚úï</button>
    </div>

    <div class="space-y-4">

      <div>
        <label>Descri√ß√£o</label>
        <input id="despDescricao" class="input" placeholder="Ex: Limpeza do pr√©dio">
      </div>

      <div>
        <label>Categoria</label>
        <select id="despCategoria" class="input">
          <option value="manutencao">Manuten√ß√£o</option>
          <option value="limpeza">Limpeza</option>
          <option value="energia">Energia</option>
          <option value="agua">√Ågua</option>
          <option value="impostos">Impostos</option>
          <option value="outros">Outros</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label>Valor (R$)</label>
          <input id="despValor" type="number" step="0.01" class="input" placeholder="0,00">
        </div>

        <div>
          <label>Data</label>
          <input id="despData" type="date" class="input">
        </div>
      </div>

      <div>
        <label>Fornecedor</label>
        <input id="despFornecedor" class="input" placeholder="Nome do fornecedor">
      </div>

      <div>
        <label>Pr√©dio (opcional)</label>
        <select id="despPredio" class="input">
          <option value="">Selecione um pr√©dio</option>
        </select>
      </div>

    </div>

    <div class="flex gap-2 mt-6">
      <button class="btn btn-primary flex-1" onclick="salvarDespesa()">‚úî Salvar</button>
      <button class="btn btn-ghost" onclick="closeModal('modalDespesa')">Cancelar</button>
    </div>
  </div>
</div>

</body>
</html>


