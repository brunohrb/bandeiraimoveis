
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Bandeira's Imobiliaria Gest√£o Financeira ‚Ä¢ 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
.card-full {
  max-width: 100% !important;
}
        :root{ --bg:#f8fafc; --primary:#1e3a8a; --border:#e2e8f0; }
        body{ font-family: 'Inter', sans-serif; background:var(--bg); color:#1e293b; }
        .sidebar{ background:#0f172a; min-height:100vh; width:260px; position:fixed; color:white; padding:20px; }
        .main{ margin-left: 260px; padding:40px; }
.card{
  background:white;
  border-radius:16px;
  padding:16px 16px 14px;
  border:1px solid var(--border);
  box-shadow:0 8px 28px rgba(0,0,0,0.06);
  width:100%;
  max-width:420px;
  max-height:calc(100vh - 40px);
  overflow-y:auto;
}
        .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); z-index:100; align-items:center; justify-content:center; }
       .btn{
  padding:8px 14px;
  border-radius:10px;
  font-weight:600;
  font-size:14px;
  cursor:pointer;
  transition:all .2s ease;
  border:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.btn-primary{
  background:var(--primary);
  color:white;
}
.btn-ghost{
  background:#f8fafc;
  color:#475569;
}
        .tag{ padding:4px 8px; border-radius:6px; font-size:11px; font-weight:800; text-transform:uppercase; display: inline-block;}
        .tag-free{ background:#dcfce7; color:#166534; }
        .tag-late{ background:#fee2e2; color:#991b1b; }
        .tag-occupied{ background:#e0f2fe; color:#0369a1; }
        .input{ width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; margin-top:4px; outline:none; }
        .payment-month { cursor: pointer; transition: transform 0.2s; }
        .payment-month:hover { transform: scale(1.05); }
label{
  font-size:12px;
  font-weight:600;
  color:#475569;
  letter-spacing:.02em;
}
.input{
  padding:10px 12px;
  font-size:14px;
  border-radius:10px;
}
@media (max-width: 640px){
  .card{
    max-width:94%;
    padding:14px;
    border-radius:18px;
  }
  .btn{
    width:100%;
  }
  .grid{
    grid-template-columns:1fr !important;
  }
}
@media (max-width:640px){
  .btn{
    width:100%;
  }
}
    </style>
</head>
<body>

<div class="sidebar">
    <div class="mb-10 p-2 bg-blue-900 rounded-lg shadow-xl">
        <h2 class="text-xl font-extrabold italic text-center">Bandeira's</h2>
        <p class="text-xs text-center font-medium text-blue-300">Gest√£o Financeira</p>
    </div>
    <nav class="space-y-2">
<div onclick="showView('viewPortfolio')" class="p-3 bg-slate-800 rounded-lg cursor-pointer flex items-center gap-3 hover:bg-slate-700">
  <i class="fas fa-home"></i> Portf√≥lio
</div>
<div onclick="showView('viewFinanceiro')" class="p-3 bg-slate-800 rounded-lg cursor-pointer flex items-center gap-3 hover:bg-slate-700">
  <i class="fas fa-chart-line"></i> Financeiro
</div>
        <div onclick="resetarSistema()" class="p-3 text-slate-400 hover:text-white cursor-pointer flex items-center gap-3 mt-10"><i class="fas fa-trash"></i> Resetar Sistema</div>
    </nav>
</div>

<div class="main">

<div id="viewFinanceiro" style="display:none;">
  <h1 class="text-3xl font-black mb-6">DASHBOARD FINANCEIRO</h1>
<div class="flex gap-4 mb-8 flex-wrap">
  <select id="filtroMes" class="input w-40"></select>
  <select id="filtroAno" class="input w-32"></select>
  <select id="filtroPredio" class="input w-64"></select>
  <button class="btn btn-primary" onclick="aplicarFiltros()">Aplicar filtros</button>
  <button class="btn btn-primary" onclick="abrirModalDespesa()">‚ûï Nova despesa</button>
</div>
<div class="grid grid-cols-3 gap-4 mb-10">
  <div class="card"><p class="text-xs uppercase text-slate-400">Alugu√©is Recebidos</p><p id="finAlugueis" class="text-2xl font-black text-green-700">R$ 0,00</p></div>
  <div class="card"><p class="text-xs uppercase text-slate-400">Juros / Multas</p><p id="finJuros" class="text-2xl font-black text-amber-600">R$ 0,00</p></div>
  <div class="card"><p class="text-xs uppercase text-slate-400">Cau√ß√µes (saldo)</p><p id="finCaucao" class="text-2xl font-black text-purple-700">R$ 0,00</p></div>
  <div class="card"><p class="text-xs uppercase text-slate-400">Total Despesas</p><p id="finDespesas" class="text-2xl font-black text-red-700">R$ 0,00</p></div>
  <div class="card"><p class="text-xs uppercase text-slate-400">Inadimpl√™ncia (M√™s Atual)</p><p id="finInadimplencia" class="text-2xl font-black text-red-600">R$ 0,00</p></div>
  <div class="card"><p class="text-xs uppercase text-slate-400">Lucro (L√≠quido)</p><p id="finLucro" class="text-2xl font-black text-emerald-700">R$ 0,00</p></div>
</div>
<div class="card card-full mt-10">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-black">Detalhamento de Despesas</h2>
  </div>
  <div class="max-h-80 overflow-y-auto border rounded-lg">
    <table class="w-full text-sm">
     <thead class="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0">
  <tr>
    <th class="p-3 text-left">Descri√ß√£o</th>
    <th class="p-3 text-left">Pr√©dio</th>
    <th class="p-3 text-left">Categoria</th>
    <th class="p-3 text-left">Data</th>
    <th class="p-3 text-right">Valor</th>
    <th class="p-3 text-center">A√ß√µes</th>
  </tr>
</thead>
      <tbody id="listaDespesas"></tbody>
    </table>
  </div>
</div>
</div>

<div id="viewPortfolio">
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">GEST√ÉO DE PORTF√ìLIO</h1>
            <p id="dataAtual" class="text-slate-500">Controle de pr√©dios e inquilinos.</p>
        </div>
        <button class="btn btn-primary" onclick="openModal('modalPredio')"><i class="fas fa-plus"></i> NOVO PR√âDIO</button>
    </header>
<div id="gridPredios" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
</div>

<!-- MODAIS -->
<div id="modalPredio" class="modal"><div class="card w-[450px]"><h3 class="font-black text-xl mb-6">CADASTRAR PR√âDIO</h3><label class="text-xs font-bold text-slate-400 uppercase">Nome do Condom√≠nio</label><input id="pNome" class="input mb-4" placeholder="Ex: Edif√≠cio Mar Azul"><label class="text-xs font-bold text-slate-400 uppercase">Unidades (Separe por v√≠rgula)</label><textarea id="pUnidades" class="input h-24 mb-6" placeholder="Apto 101, Apto 102, Cobertura..."></textarea><div class="flex gap-2"><button class="btn btn-primary flex-1 justify-center" onclick="addPredio()">CRIAR PR√âDIO</button><button class="btn btn-ghost" onclick="closeModal('modalPredio')"><i class="fas fa-arrow-left"></i> VOLTAR</button></div></div></div>
<div id="modalDetalhe" class="modal"><div class="card w-[90%] max-w-5xl max-h-[80vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><h3 id="detalheTitulo" class="font-black text-2xl uppercase italic"></h3><button class="btn btn-ghost" onclick="closeModal('modalDetalhe')"><i class="fas fa-times"></i> FECHAR</button></div><table class="w-full text-left"><thead class="text-xs text-slate-400 uppercase border-b"><tr><th class="pb-3">Unidade</th><th class="pb-3">Inquilino</th><th class="pb-3">Valor</th><th class="pb-3">Venc.</th><th class="pb-3">Status</th><th class="pb-3">Financeiro</th><th class="pb-3">Contrato</th><th class="pb-3 text-right">A√ß√µes</th></tr></thead><tbody id="listaUnidades"></tbody></table></div></div>
<div id="modalInquilino" class="modal"><div class="card w-[450px]"><h3 id="inqTitulo" class="font-black text-xl mb-6 uppercase">GERIR INQUILINO</h3><input type="hidden" id="inqUnidadeId"><input type="hidden" id="inqPredioId"><div class="space-y-4"><div><label class="text-xs font-bold">Nome Completo</label><input id="inqNome" class="input mb-3"><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="text-xs font-bold">Nacionalidade</label><input id="inqNacionalidade" class="input"></div><div><label class="text-xs font-bold">Profiss√£o</label><input id="inqProfissao" class="input"></div></div><label class="text-xs font-bold">Identidade (RG)</label><input id="inqRG" class="input mb-3"><label class="text-xs font-bold">CPF</label><input id="inqCPF" class="input mb-3"><label class="text-xs font-bold">Telefone / WhatsApp</label><input id="inqTelefone" class="input mb-3" placeholder="(85) 9xxxx-xxxx"><label class="text-xs font-bold">Endere√ßo Completo</label><textarea id="inqEndereco" class="input mb-3"></textarea><label class="text-xs font-bold">Cau√ß√£o (R$)</label><input id="inqCaucao" class="input mb-3"><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="text-xs font-bold">Aluguel (R$)</label><input id="inqValor" class="input" placeholder="Ex: 1.350,00"></div><div><label class="text-xs font-bold">Dia de vencimento</label><input id="inqVenc" type="number" min="1" max="31" class="input"></div></div><label class="text-xs font-bold text-slate-400 uppercase">Anexo do Contrato (.pdf/imagem)</label><input id="inqArquivo" type="file" class="text-xs mt-2 block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><div id="viewContrato" class="mt-2 hidden"><a href="#" target="_blank" class="text-blue-600 font-bold text-xs underline uppercase tracking-widest"><i class="fas fa-file-pdf"></i> Visualizar Atual</a></div></div><div class="flex gap-2 pt-4"><button class="btn btn-ghost w-full mb-2" onclick="gerarContratoPDF()">üìÑ Gerar contrato (PDF)</button><button class="btn btn-primary flex-1 justify-center" onclick="saveInquilino()">SALVAR DADOS</button><button id="btnVacar" class="btn btn-ghost text-red-600" onclick="vacarUnidade()">REMOVER</button><button class="btn btn-ghost" onclick="closeModal('modalInquilino')"><i class="fas fa-arrow-left"></i> VOLTAR</button></div></div></div></div>
<div id="modalPagamentos" class="modal"><div class="card w-[450px]"><div class="flex justify-between items-center mb-6"><h3 id="pagamentosTitulo" class="font-black text-xl uppercase">Hist√≥rico</h3><button class="btn btn-ghost" onclick="closeModalPagamentos()"><i class="fas fa-times"></i> FECHAR</button></div><div id="gridPagamentos" class="grid grid-cols-4 gap-4"></div></div></div>
<div id="modalBaixaPagamento" class="modal"><div class="card w-[380px]"><div class="flex justify-between items-center mb-4"><h3 id="baixaTitulo" class="font-black text-lg uppercase">Baixa de Pagamento</h3><button class="btn btn-ghost" onclick="closeModal('modalBaixaPagamento')"><i class="fas fa-times"></i></button></div><p id="baixaSubtitulo" class="text-xs text-slate-500 mb-4"></p><div class="space-y-3"><div><label class="text-xs font-bold">Aluguel pago (R$)</label><input id="bpAluguel" type="number" step="0.01" class="input" oninput="atualizarTotalBaixa()"></div><div><label class="text-xs font-bold">Juros / Multa (R$)</label><input id="bpJuros" type="number" step="0.01" class="input" value="0" oninput="atualizarTotalBaixa()"></div><div><label class="text-xs font-bold">Data do pagamento</label><input id="bpData" type="date" class="input"></div><div class="bg-slate-50 p-3 rounded-lg border text-center"><p class="text-xs text-slate-400 uppercase font-bold">Total recebido</p><p id="bpTotal" class="text-xl font-black text-slate-800">R$ 0,00</p></div></div><div class="flex gap-2 mt-6"><button class="btn btn-primary flex-1 justify-center" onclick="confirmarPagamento()">Confirmar pagamento</button><button class="btn btn-ghost" onclick="closeModal('modalBaixaPagamento')">Cancelar</button></div></div></div>
<div id="modalDespesa" class="modal"><div class="card w-[450px]"><h3 class="font-black text-xl mb-6">LAN√áAR DESPESA</h3><form id="despForm" class="space-y-4"><div><label>Descri√ß√£o</label><input id="despDescricao" class="input"></div><div class="grid grid-cols-2 gap-4"><div><label>Categoria</label><select id="despCategoria" class="input"><option>Manuten√ß√£o</option><option>Limpeza</option><option>Obras</option><option>Impostos</option><option>Outra</option></select></div><div><label>Pr√©dio (Opcional)</label><select id="despPredio" class="input"></select></div></div><div class="grid grid-cols-2 gap-4"><div><label>Valor (R$)</label><input id="despValor" type="number" class="input"></div><div><label>Data</label><input id="despData" type="date" class="input"></div></div></form><div class="flex gap-2 mt-6"><button class="btn btn-primary flex-1" onclick="salvarDespesa()">‚úî Salvar</button><button class="btn btn-ghost" onclick="closeModal('modalDespesa')">Cancelar</button></div></div></div>

</div>
</body>
<script>
// ========================================================================
// CONFIGURA√á√ÉO E ESTADO GLOBAL
// ========================================================================
const SUPABASE_URL = 'https://fmwmrjawsitbblkxaoxo.supabase.co';
const SUPABASE_KEY = 'sb_publishable_uz9C7uRoMV8nvFAx-L7Dfg_mdOQ2L4X';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let db = { predios: [], despesas: [] };
let currentViewingPredioId = null;
let currentBase64 = "";
const MESES = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

// ========================================================================
// INICIALIZA√á√ÉO E CARREGAMENTO DE DADOS
// ========================================================================
document.addEventListener('DOMContentLoaded', async () => {
    showView('viewPortfolio');
    await carregarDadosIniciais();
    render();
    configurarFiltros();
    document.getElementById('dataAtual').textContent = `Controle de pr√©dios e inquilinos. Data Atual: ${new Date().toLocaleDateString('pt-BR')}`;
});

async function carregarDadosIniciais() {
    console.log("Carregando dados do Supabase...");
    const { data: prediosData, error: prediosError } = await supabase.from('predios').select('*, unidades(*, inquilinos(*))');
    if (prediosError) {
        console.error('Erro ao carregar pr√©dios:', prediosError);
        return;
    }

    const { data: despesasData, error: despesasError } = await supabase.from('despesas').select('*');
    if (despesasError) {
        console.error('Erro ao carregar despesas:', despesasError);
        return;
    }

    db.predios = prediosData || [];
    db.despesas = despesasData || [];
    console.log("Dados carregados:", db);
}

// ========================================================================
// RENDERIZA√á√ÉO E UI
// ========================================================================
function render() {
    renderGridPredios();
    renderDashboardFinanceiro();
    renderListaDespesas();
}

function renderGridPredios() {
    const grid = document.getElementById('gridPredios');
    grid.innerHTML = db.predios.map(p => {
        const unidadesOcupadas = p.unidades.filter(u => u.status === 'ocupado').length;
        const totalUnidades = p.unidades.length;
        return `
            <div class="card cursor-pointer hover:border-blue-500" onclick="viewPredio(${p.id})">
                <h4 class="font-black text-lg">${p.nome}</h4>
                <p class="text-sm text-slate-500">${totalUnidades} unidades</p>
                <div class="mt-4 text-xs">Ocupa√ß√£o: ${unidadesOcupadas} de ${totalUnidades}</div>
            </div>
        `;
    }).join('');
}

function showView(viewId) {
    document.getElementById('viewPortfolio').style.display = 'none';
    document.getElementById('viewFinanceiro').style.display = 'none';
    document.getElementById(viewId).style.display = 'block';
}

function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; currentBase64 = ""; }

// ========================================================================
// OPERA√á√ïES DE PR√âDIOS E UNIDADES
// ========================================================================
async function addPredio() {
    const nome = document.getElementById('pNome').value;
    const unidadesTxt = document.getElementById('pUnidades').value;
    if (!nome || !unidadesTxt) return alert('Preencha todos os campos!');

    // 1. Insere o pr√©dio
    const { data: predioData, error: predioError } = await supabase.from('predios').insert({ nome }).select().single();
    if (predioError) return console.error("Erro ao criar pr√©dio:", predioError);

    // 2. Prepara as unidades
    const unidades = unidadesTxt.split(',').map(u => ({ 
        nome: u.trim(), 
        status: 'vago', 
        predio_id: predioData.id 
    }));

    // 3. Insere as unidades
    const { error: unidadesError } = await supabase.from('unidades').insert(unidades);
    if (unidadesError) return console.error("Erro ao criar unidades:", unidadesError);

    await carregarDadosIniciais();
    render();
    closeModal('modalPredio');
}

async function viewPredio(predioId) {
    currentViewingPredioId = predioId;
    const p = db.predios.find(x => x.id === predioId);
    if (!p) return;

    document.getElementById('detalheTitulo').innerText = p.nome;
    const lista = document.getElementById('listaUnidades');
    lista.innerHTML = p.unidades.map(u => {
        const inquilino = u.inquilinos;
        const statusTag = u.status === 'vago' ? '<span class="tag tag-free">Vago</span>' : '<span class="tag tag-occupied">Ocupado</span>';
        const inquilinoNome = inquilino ? `<span class="font-medium">${inquilino.nome}</span>` : '<span class="text-slate-400 italic">Dispon√≠vel</span>';
        const contratoBtn = inquilino && inquilino.contrato_url ? `<a href="${inquilino.contrato_url}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf"></i> Ver</a>` : '-';
        
        let financeiroTag = '-';
        if (inquilino) {
            const mesAtual = new Date().getMonth();
            const pagamentoMes = inquilino.pagamentos ? inquilino.pagamentos[mesAtual] : null;
            if (pagamentoMes && pagamentoMes.pago) {
                financeiroTag = '<span class="tag tag-free">Pago</span>';
            } else if (new Date().getDate() > inquilino.venc) {
                financeiroTag = '<span class="tag tag-late">Atrasado</span>';
            }
        }

        return `
            <tr class="border-b hover:bg-slate-50 text-sm">
                <td class="py-4 font-bold">${u.nome}</td>
                <td>${inquilinoNome}</td>
                <td>${inquilino ? `R$ ${inquilino.valor_aluguel}` : '-'}</td>
                <td>${inquilino ? `Dia ${inquilino.venc}` : '-'}</td>
                <td>${statusTag}</td>
                <td>${financeiroTag}</td>
                <td>${contratoBtn}</td>
                <td class="text-right">
                    <button onclick="editInquilino(${p.id}, ${u.id})" class="text-blue-600 font-black text-xs uppercase hover:underline">
                        <i class="fas fa-edit"></i> ${inquilino ? 'EDITAR' : 'ALUGAR'}
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    openModal('modalDetalhe');
}

// ========================================================================
// OPERA√á√ïES DE INQUILINOS
// ========================================================================
function editInquilino(predioId, unidadeId) {
    const p = db.predios.find(x => x.id === predioId);
    const u = p.unidades.find(x => x.id === unidadeId);
    const inquilino = u.inquilinos;

    document.getElementById('inqPredioId').value = predioId;
    document.getElementById('inqUnidadeId').value = unidadeId;
    document.getElementById('inqTitulo').innerText = `${p.nome} - ${u.nome}`;

    if (inquilino) {
        document.getElementById('inqNome').value = inquilino.nome || '';
        document.getElementById('inqNacionalidade').value = inquilino.nacionalidade || '';
        document.getElementById('inqProfissao').value = inquilino.profissao || '';
        document.getElementById('inqRG').value = inquilino.rg || '';
        document.getElementById('inqCPF').value = inquilino.cpf || '';
        document.getElementById('inqTelefone').value = inquilino.telefone || '';
        document.getElementById('inqEndereco').value = inquilino.endereco || '';
        document.getElementById('inqCaucao').value = inquilino.valor_caucao || '';
        document.getElementById('inqValor').value = inquilino.valor_aluguel || '';
        document.getElementById('inqVenc').value = inquilino.venc || '';
        document.getElementById('btnVacar').style.display = 'block';
    } else {
        document.getElementById('inqForm').reset();
        document.getElementById('btnVacar').style.display = 'none';
    }
    openModal('modalInquilino');
}

async function saveInquilino() {
    const predioId = document.getElementById('inqPredioId').value;
    const unidadeId = document.getElementById('inqUnidadeId').value;
    const p = db.predios.find(x => x.id == predioId);
    const u = p.unidades.find(x => x.id == unidadeId);

    const inquilinoData = {
        nome: document.getElementById('inqNome').value,
        nacionalidade: document.getElementById('inqNacionalidade').value,
        profissao: document.getElementById('inqProfissao').value,
        rg: document.getElementById('inqRG').value,
        cpf: document.getElementById('inqCPF').value,
        telefone: document.getElementById('inqTelefone').value,
        endereco: document.getElementById('inqEndereco').value,
        valor_caucao: parseFloat(document.getElementById('inqCaucao').value) || 0,
        valor_aluguel: parseFloat(document.getElementById('inqValor').value) || 0,
        venc: parseInt(document.getElementById('inqVenc').value) || 10,
        unidade_id: unidadeId,
        pagamentos: u.inquilinos?.pagamentos || Array.from({ length: 12 }, () => ({ pago: false }))
    };

    if (u.inquilinos) { // Atualiza inquilino existente
        const { error } = await supabase.from('inquilinos').update(inquilinoData).eq('id', u.inquilinos.id);
        if (error) return console.error("Erro ao atualizar inquilino:", error);
    } else { // Cria novo inquilino
        const { data: newInquilino, error } = await supabase.from('inquilinos').insert(inquilinoData).select().single();
        if (error) return console.error("Erro ao criar inquilino:", error);
        // Atualiza o status da unidade
        const { error: updateError } = await supabase.from('unidades').update({ status: 'ocupado' }).eq('id', unidadeId);
        if (updateError) return console.error("Erro ao atualizar status da unidade:", updateError);
    }

    await carregarDadosIniciais();
    render();
    closeModal('modalInquilino');
    viewPredio(predioId);
}

async function vacarUnidade() {
    const predioId = document.getElementById('inqPredioId').value;
    const unidadeId = document.getElementById('inqUnidadeId').value;
    const p = db.predios.find(x => x.id == predioId);
    const u = p.unidades.find(x => x.id == unidadeId);

    if (!u.inquilinos || !confirm("Tem certeza que deseja remover este inquilino e vagar a unidade?")) return;

    // 1. Deleta o inquilino
    const { error: deleteError } = await supabase.from('inquilinos').delete().eq('id', u.inquilinos.id);
    if (deleteError) return console.error("Erro ao deletar inquilino:", deleteError);

    // 2. Atualiza a unidade para 'vago'
    const { error: updateError } = await supabase.from('unidades').update({ status: 'vago' }).eq('id', unidadeId);
    if (updateError) return console.error("Erro ao vagar unidade:", updateError);

    await carregarDadosIniciais();
    render();
    closeModal('modalInquilino');
    viewPredio(predioId);
}

// ========================================================================
// OPERA√á√ïES FINANCEIRAS E DESPESAS
// ========================================================================
function configurarFiltros() {
    const filtroMes = document.getElementById('filtroMes');
    const filtroAno = document.getElementById('filtroAno');
    const filtroPredio = document.getElementById('filtroPredio');

    filtroMes.innerHTML = '<option value="all">Todos os Meses</option>' + MESES.map((m, i) => `<option value="${i}">${m}</option>`).join('');
    const anoAtual = new Date().getFullYear();
    filtroAno.innerHTML = `<option value="${anoAtual}">${anoAtual}</option>`; // Apenas ano atual por enquanto
    filtroPredio.innerHTML = '<option value="all">Todos os Pr√©dios</option>' + db.predios.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
}

function aplicarFiltros() {
    renderDashboardFinanceiro();
    renderListaDespesas();
}

function renderDashboardFinanceiro() {
    const mesFiltro = document.getElementById('filtroMes').value;
    const predioFiltro = document.getElementById('filtroPredio').value;

    let alugueisRecebidos = 0, jurosMultas = 0, saldoCaucoes = 0, totalDespesas = 0, inadimplenciaMes = 0;

    db.predios.forEach(p => {
        if (predioFiltro !== 'all' && p.id != predioFiltro) return;

        p.unidades.forEach(u => {
            if (u.inquilinos) {
                saldoCaucoes += parseFloat(u.inquilinos.valor_caucao || 0);
                
                u.inquilinos.pagamentos.forEach((pag, mes) => {
                    if (mesFiltro !== 'all' && mes != mesFiltro) return;

                    if (pag.pago) {
                        alugueisRecebidos += parseFloat(pag.aluguel || 0);
                        jurosMultas += parseFloat(pag.juros || 0);
                    }
                });

                // C√°lculo de inadimpl√™ncia para o m√™s atual
                const mesAtual = new Date().getMonth();
                const pagamentoMesAtual = u.inquilinos.pagamentos[mesAtual];
                if (!pagamentoMesAtual.pago && new Date().getDate() > u.inquilinos.venc) {
                    inadimplenciaMes += parseFloat(u.inquilinos.valor_aluguel || 0);
                }
            }
        });
    });

    db.despesas.forEach(d => {
        const dataDespesa = new Date(d.data);
        if (predioFiltro !== 'all' && d.predio_id != predioFiltro) return;
        if (mesFiltro !== 'all' && dataDespesa.getMonth() != mesFiltro) return;
        totalDespesas += parseFloat(d.valor || 0);
    });

    document.getElementById('finAlugueis').textContent = `R$ ${alugueisRecebidos.toFixed(2)}`;
    document.getElementById('finJuros').textContent = `R$ ${jurosMultas.toFixed(2)}`;
    document.getElementById('finCaucao').textContent = `R$ ${saldoCaucoes.toFixed(2)}`;
    document.getElementById('finDespesas').textContent = `R$ ${totalDespesas.toFixed(2)}`;
    document.getElementById('finInadimplencia').textContent = `R$ ${inadimplenciaMes.toFixed(2)}`;
    document.getElementById('finLucro').textContent = `R$ ${(alugueisRecebidos + jurosMultas - totalDespesas).toFixed(2)}`;
}

function renderListaDespesas() {
    const lista = document.getElementById('listaDespesas');
    const mesFiltro = document.getElementById('filtroMes').value;
    const predioFiltro = document.getElementById('filtroPredio').value;

    const despesasFiltradas = db.despesas.filter(d => {
        const dataDespesa = new Date(d.data);
        const mesOk = mesFiltro === 'all' || dataDespesa.getMonth() == mesFiltro;
        const predioOk = predioFiltro === 'all' || d.predio_id == predioFiltro;
        return mesOk && predioOk;
    });

    lista.innerHTML = despesasFiltradas.map(d => {
        const predioNome = db.predios.find(p => p.id === d.predio_id)?.nome || 'Geral';
        return `
            <tr class="border-b">
                <td class="p-3">${d.descricao}</td>
                <td class="p-3">${predioNome}</td>
                <td class="p-3">${d.categoria}</td>
                <td class="p-3">${new Date(d.data).toLocaleDateString('pt-BR')}</td>
                <td class="p-3 text-right">R$ ${d.valor.toFixed(2)}</td>
                <td class="p-3 text-center"><button onclick="excluirDespesa(${d.id})" class="text-red-500 hover:underline">Excluir</button></td>
            </tr>
        `;
    }).join('');
}

function abrirModalDespesa() {
    document.getElementById('despForm').reset();
    const selectPredio = document.getElementById('despPredio');
    selectPredio.innerHTML = '<option value="">Geral</option>' + db.predios.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
    openModal('modalDespesa');
}

async function salvarDespesa() {
    const despesaData = {
        descricao: document.getElementById('despDescricao').value,
        categoria: document.getElementById('despCategoria').value,
        predio_id: document.getElementById('despPredio').value || null,
        valor: parseFloat(document.getElementById('despValor').value),
        data: document.getElementById('despData').value
    };

    if (!despesaData.descricao || !despesaData.valor || !despesaData.data) return alert('Preencha todos os campos obrigat√≥rios!');

    const { error } = await supabase.from('despesas').insert(despesaData);
    if (error) return console.error("Erro ao salvar despesa:", error);

    await carregarDadosIniciais();
    render();
    closeModal('modalDespesa');
}

async function excluirDespesa(id) {
    if (!confirm("Tem certeza que deseja excluir esta despesa?")) return;
    const { error } = await supabase.from('despesas').delete().eq('id', id);
    if (error) return console.error("Erro ao excluir despesa:", error);
    await carregarDadosIniciais();
    render();
}

async function resetarSistema() {
    if (!confirm("ATEN√á√ÉO! ISSO APAGAR√Å TODOS OS DADOS NO BANCO DE DADOS (SUPABASE). ESSA A√á√ÉO N√ÉO PODE SER DESFEITA. Deseja continuar?")) return;
    
    console.log("Iniciando reset do sistema...");
    const { error: inquilinosError } = await supabase.from('inquilinos').delete().neq('id', 0);
    if (inquilinosError) console.error('Erro ao deletar inquilinos:', inquilinosError);

    const { error: unidadesError } = await supabase.from('unidades').delete().neq('id', 0);
    if (unidadesError) console.error('Erro ao deletar unidades:', unidadesError);

    const { error: prediosError } = await supabase.from('predios').delete().neq('id', 0);
    if (prediosError) console.error('Erro ao deletar predios:', prediosError);

    const { error: despesasError } = await supabase.from('despesas').delete().neq('id', 0);
    if (despesasError) console.error('Erro ao deletar despesas:', despesasError);

    alert("Sistema resetado com sucesso!");
    await carregarDadosIniciais();
    render();
}

function viewPagamentos(inquilinoId) {
    const inquilino = db.predios.flatMap(p => p.unidades).map(u => u.inquilinos).find(i => i && i.id === inquilinoId);
    if (!inquilino) return;

    document.getElementById('pagamentosTitulo').innerText = `Hist√≥rico de ${inquilino.nome.split(' ')[0]}`;
    const grid = document.getElementById('gridPagamentos');
    grid.innerHTML = MESES.map((mes, i) => {
        const pag = inquilino.pagamentos[i];
        let statusClass = 'bg-slate-200 text-slate-600';
        let text = mes;
        if (pag.pago) {
            statusClass = 'bg-green-200 text-green-800';
            text = `‚úî ${mes}`;
        } else if (new Date().getMonth() > i && new Date().getDate() > inquilino.venc) {
            statusClass = 'bg-red-200 text-red-800';
            text = `‚úñ ${mes}`;
        }
        return `<div class="${statusClass} p-2 rounded-lg text-center font-bold text-sm cursor-pointer" onclick="openModalBaixaPagamento(${inquilino.id}, ${i})">${text}</div>`;
    }).join('');
    openModal('modalPagamentos');
}

function openModalBaixaPagamento(inquilinoId, mes) {
    const inquilino = db.predios.flatMap(p => p.unidades).map(u => u.inquilinos).find(i => i && i.id === inquilinoId);
    const unidade = db.predios.flatMap(p => p.unidades).find(u => u.inquilinos && u.inquilinos.id === inquilinoId);
    const predio = db.predios.find(p => p.id === unidade.predio_id);

    document.getElementById('baixaSubtitulo').innerText = `${inquilino.nome} / ${predio.nome} - ${unidade.nome}`;
    document.getElementById('bpAluguel').value = inquilino.valor_aluguel;
    document.getElementById('bpJuros').value = 0;
    document.getElementById('bpData').valueAsDate = new Date();
    document.getElementById('confirmarPagamentoBtn').onclick = () => confirmarPagamento(inquilinoId, mes);
    atualizarTotalBaixa();
    openModal('modalBaixaPagamento');
}

function atualizarTotalBaixa() {
    const aluguel = parseFloat(document.getElementById('bpAluguel').value) || 0;
    const juros = parseFloat(document.getElementById('bpJuros').value) || 0;
    document.getElementById('bpTotal').textContent = `R$ ${(aluguel + juros).toFixed(2)}`;
}

async function confirmarPagamento(inquilinoId, mes) {
    const inquilino = db.predios.flatMap(p => p.unidades).map(u => u.inquilinos).find(i => i && i.id === inquilinoId);
    const novosPagamentos = [...inquilino.pagamentos];
    novosPagamentos[mes] = {
        pago: true,
        aluguel: parseFloat(document.getElementById('bpAluguel').value),
        juros: parseFloat(document.getElementById('bpJuros').value),
        data: document.getElementById('bpData').value
    };

    const { error } = await supabase.from('inquilinos').update({ pagamentos: novosPagamentos }).eq('id', inquilinoId);
    if (error) return console.error("Erro ao confirmar pagamento:", error);

    await carregarDadosIniciais();
    render();
    closeModal('modalBaixaPagamento');
    closeModal('modalPagamentos');
    viewPredio(currentViewingPredioId);
}

function gerarContratoPDF() {
    alert("Fun√ß√£o de gerar PDF ainda n√£o implementada com os dados do Supabase.");
    // A implementa√ß√£o original usava muitos campos que agora est√£o no Supabase.
    // Precisaria reescrever essa fun√ß√£o para buscar os dados do inquilino e gerar o PDF.
}



</script>
</script>
</html>
